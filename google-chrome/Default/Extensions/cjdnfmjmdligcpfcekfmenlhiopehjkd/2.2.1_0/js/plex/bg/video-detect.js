(()=>{const e="{origin}{path}?Accept-Language=en&includeConcerts=1&includeExtras=1&includeOnDeck=1&includePopularLeaves=1&includePreferences=1&includeChapters=1&includeStations=1&includeExternalMedia=1&asyncAugmentMetadata=1&checkFiles=1&X-Plex-Text-Format=plain",t="{origin}/video/:/transcode/universal/ping?session={session}",r=new Set(["X-Plex-Product","X-Plex-Version","X-Plex-Client-Identifier","X-Plex-Platform","X-Plex-Platform-Version","X-Plex-Sync-Version","X-Plex-Features","X-Plex-Model","X-Plex-Device","X-Plex-Device-Name","X-Plex-Device-Screen-Resolution","X-Plex-Token","X-Plex-Language"]),n=new XRegExp("https?://(.*\\.)?plex.direct:[0-9]+/video/:/transcode/universal/decision.*"),s=new XRegExp("https?://(.*\\.)?plex.direct:[0-9]+/video/:/transcode/universal/start.mpd.*"),i=new XRegExp("https?://(.*\\.)?plex.direct:[0-9]+/library/parts/(?<contentID>[0-9a-f]+)/.*/file.mp4.*"),a=new XRegExp("https?://(.*\\.)?plex.direct:[0-9]+/media/providers.*"),o=new XRegExp("(?<ip>[0-9]+-[0-9]+-[0-9]+-[0-9]+)\\.[a-f0-9]+\\.plex\\.direct:[0-9]+");async function l(t,r){"string"==typeof t&&(t=new URI(t));const n=t.query(!0),s=e.replace(/{origin}/,t.origin()).replace(/{path}/,n.path),i=new URI(s);c(i,n);const a=i.toString(),o=await axios.get(a),{data:l}=o,{MediaContainer:{Metadata:[{title:d,art:p}]}}=l;return{title:d,poster:p}}function c(e,t,n){Array.from(r).forEach(r=>{const s=t[r];void 0!==s&&(n&&addHeaderEntry(r,t[r],n),e.addSearch(r,s))})}browser.webRequest.onBeforeRequest.addListener(e=>{const{url:t}=e;try{if(!settings[SETTINGS.plex.forceWAN]||!a.test(t))return}catch(e){return void console.warn(e)}const r=new URL(t),{host:n}=r,s=XRegExp.exec(n,o);if(null===s||!s.ip)return{cancel:!0};const i=s.ip.replace(/-/gm,".");return IP.isPrivate(i)?{cancel:!0}:void 0},{urls:["<all_urls>"]},["blocking"]),browser.webRequest.onBeforeRequest.addListener(e=>{const{url:t}=e;try{if(settings[SETTINGS.plex.allowDirectPlay]||!n.test(t))return}catch(e){return void console.warn(e)}if(!t.includes("twoseven-bypass=true")){const t=new URI(e.url);return t.setQuery("directPlay","0"),t.setQuery("twoseven-bypass",!0),{redirectUrl:t.toString()}}},{urls:["<all_urls>"]},["blocking"]),browser.webRequest.onBeforeSendHeaders.addListener(e=>{const{url:r,tabId:n}=e,s=XRegExp.exec(r,i);if(null!==s&&s.contentID)return settings[SETTINGS.plex.allowDirectPlay]?void(async()=>{const i=new URI(r),a=i.query(!0);i.addSearch({path:`/library/metadata/${s.contentID}`});const o=await l(i),d=`url:${r}`;let p;if(settings[SETTINGS.plex.enableSessionPing]){const r=new URI(t.replace(/{origin}/,i.origin()).replace(/{session}/,a.session)),{requestHeaders:n}=e;c(r,a,n),p=r.toString()}const u={videoSelector:"web",videoURL:d,videoData:{...o,treatEachVideoAsNew:!0,module:{name:"generic",loadMediaFromModule:!1,callModuleBG:!0,addHeaders:!0},plyrProvider:"html5",plyrType:"video",plyrContentType:"video/mp4",source:"plex",sessionPingURL:p},tabId:n,origin:"https://app.plex.tv",referer:"https://app.plex.tv",strategies:["url"],headers:[]};addTabMedia(n,0,u)})():{cancel:!0}},{urls:["<all_urls>"]},["blocking"]),browser.webRequest.onBeforeSendHeaders.addListener(async e=>{const{url:r,tabId:n}=e;if(twosevenTabs[n])return;if(!s.test(r)||r.includes("x-twoseven-ignore=true"))return;const i=new URI(r),a=i.query(!0);let o;const d=new URI(t.replace(/{origin}/,i.origin()).replace(/{session}/,a.session)),{requestHeaders:p}=e;c(d,a,p);const u=await l(i),g=`${i.setQuery("directPlay","0").toString().replace(/decision/,"start.mpd")}`,x=await axios.get(g,{params:{"x-twoseven-ignore":!0},responseType:"text"}),w=`mpd:${g}`;settings[SETTINGS.plex.enableSessionPing]&&(o=d.toString());const v={videoSelector:"web",videoURL:w,videoData:{...u,plyrProvider:"html5",mediaType:"mpd",source:"plex",sessionPingURL:o,manifest:x.data},tabId:n,origin:"https://app.plex.tv",referer:"https://app.plex.tv",strategies:null,headers:[]};addTabMedia(n,0,v)},{urls:["<all_urls>"]},["requestHeaders"])})();