const iframeTabIds={},ports={},registeredIframes=new Set;class TabIframes{constructor(){this.data={}}addFrame(e,r){this.data[e]={port:r}}deletePort(e){const{sender:{frameId:r}}=e;delete this.data[r].port}has(e){return!!this.data[e]}getPort(e){return this.data[e]&&this.data[e].port}getPorts(){return Object.keys(this.data).map(e=>this.data[e]&&this.data[e].port).filter(e=>!!e)}getSubFramePorts(e){const r=Object.keys(this.data);return r.indexOf(0)>=0&&r.splice(r.indexOf(0),1),r.map(e=>this.data[e]&&this.data[e].port).filter(e=>!!e)}informSubFrames(e){this.getSubFramePorts().forEach(r=>{try{r.postMessage(e)}catch(t){console.error(`Failed to inform subframe=${r.sender.frameId} of message: ${e.action}: ${t}`)}})}}browser.tabs.onRemoved.addListener(e=>{delete iframeTabIds[e]}),(()=>{const e="iframe-bg",r=new Emittery;function t(e,r){if(!r){const t=getTabIdFromPort(e),a=twosevenTabs[t]||{},{roomType:o,roomOwner:s,roomController:n,roomProperties:d}=a;if(void 0===o||void 0===s||void 0===n)return;r={roomType:o,roomOwner:s,roomController:n,roomProperties:d}}e.postMessage({action:"room-updated",roomInfo:r})}twosevenTabs.on("change",({path:r,value:a,previousValue:o})=>{if(Number.isNaN(Number(r)))return;if(!r||!a)return;const{roomType:s,roomOwner:n,roomController:d}=a;if(void 0===s||void 0===n||void 0===d)return;const i=Number(r),c=iframeTabIds[i].getPorts(),m={roomType:s,roomOwner:n,roomController:d},f=Object.values(c).map(e=>{try{return t(e,m),e.sender.frameId}catch(r){iframeTabIds[i].deletePort(e)}}).filter(e=>!!e);twosevenExtLog(e,`Informed tabId=${i} num=${JSON.stringify(f)}`)});const a=window.twoseven.debounce(async e=>{let{tabId:r,url:t}=e;try{let e=new URI(t);const a=e.search(!0),{"ts-videoselector":o}=a;if(o){const a=await evaluateOnPageAndGetResponse(()=>window[o].mediaEntry,r,null,0);if(a){const{videoURL:r}=a;t=r,e=new URI(t)}}const s=e.domain();toast({msg:`We need to <a class="toast-close" onclick="triggerEvent(window, 'bust-cache', { url: '${t}', tabId: ${r} })">clear your cache</a> of ${s}`,delay:3e4},r)}catch(e){}},3e3),o=is.chrome(),s=is.firefox();browser.webNavigation.onErrorOccurred.addListener(async r=>{const{error:t,tabId:n,frameId:d}=r;try{if(iframeTabIds[n].data[d]){if(twosevenExtLog(e,`error=${t}: tabId=${n} frameId=${d}`),s)try{await(async(r,t)=>{const a=new Deferred,o=setTimeout(()=>a.reject("timeout"),1e3),s=`bg-x-frame-failure-detect:${uuid()}`;return browser.runtime.onMessage.addListener(function e(r){r.action===s&&(browser.runtime.onMessage.removeListener(e),clearTimeout(o),a.resolve())}),twosevenExtLog(e,`checkIfXFrameDeny: Checking whether frame loaded: tabId=${r} frameId=${t}`),browser.tabs.executeScript(r,{frameId:t,code:`triggerEvent(window, 'ts:relay-bg', JSON.stringify({ realAction: '${s}' }), true)`}),a})(n,d)}catch(t){twosevenExtLog(e,"Calling onXframeDeny since checkIfXFrameDeny failed"),a(r)}else if("net::ERR_BLOCKED_BY_RESPONSE"!==t&&o)return;if(s)return;a(r)}}catch(e){}}),browser.runtime.onConnect.addListener(a=>{const o=getTabIdFromPort(a),{frameId:s}=a.sender;let n;a.onMessage.addListener(async d=>{switch(d.action){case"register-iframe":{d.iframeNames.forEach(e=>registeredIframes.add(e)),iframeTabIds[o].addFrame(d.frameId,ports[o][d.frameId]);const r=iframeTabIds[o].data[d.frameId];r.wildcardCors=d.wildcardCors,r.frameRegistered=!0,twosevenExtLog(e,`Registered iframe: ${JSON.stringify(d.iframeNames)}`),a.postMessage({...d,action:"registered-iframe"}),t(a);break}case"room-updated":iframeTabIds[o].informSubFrames(sanitizeObject(d));break;case"url-changed":case"get-room-info":t(a);break;case"is-on-twoseven":n=!!twosevenTabs[o],a.postMessage({action:d.action,value:n});break;case"get-url":{const e=d.data;r.emit("get-url",{tabId:o,frameId:s,url:e});break}}}),a.onDisconnect.addListener(()=>{delete ports[o][s]}),iframeTabIds[o]||(iframeTabIds[o]=new TabIframes),ports[o]||(ports[o]={}),ports[o][s]=a}),window.getTwoSevenTabIframeURL=function(e,t){const a=new Promise(a=>{r.on("get-url",function o({tabId:s,frameId:n,url:d}){e===s&&t===n&&(r.off("get-url",o),a(d))})});return browser.tabs.executeScript(e,{frameId:t,code:"triggerEvent(window, 'get-url', '', true)"}),a},browser.webRequest.onHeadersReceived.addListener(e=>{if(function(e){const{tabId:r,frameId:t}=e,a=iframeTabIds[r];return!(!a||!a.has(t))}(e)){const{url:r,tabId:t,frameId:a}=e,o=iframeTabIds[t].data[a];o.frameRegistered&&(o.wildcardCors&&addCORS(e.responseHeaders),(!window.test||window.test&&localStorage.getItem("no-block"))&&addXFrameOptions(e.responseHeaders));const s=new URI(r).query(!0)["ts-fixup"];if(s)try{new Set(s.split(",")).has("cors")&&addCORS(e.responseHeaders)}catch(e){}}return{responseHeaders:e.responseHeaders}},{urls:["<all_urls>"]},["blocking","responseHeaders"])})();