const vlivePremiumContent=new PerTabData;(()=>{const e="[vlive.tv:video-detect]";browser.runtime.onConnect.addListener(t=>{if("vlive.tv:detect-premium"!==t.name)return;const r=getTabIdFromPort(t);t.onMessage.addListener(t=>{const{action:a,data:o}=t;switch(a){case"detect":{const{isPremiumVideo:t}=o;vlivePremiumContent[r]=t,t&&(twosevenExtLog(e,`Marked tab=${r} as premium`),blacklistedTabs[r]=!0)}}})}),browser.webRequest.onBeforeSendHeaders.addListener(async t=>{const{tabId:r,frameId:a}=t;if(0!==a||r<0)return;const o=tabURLs[r],i=await axios.get(t.url),{data:n}=i,{meta:s,videos:d,captions:c={}}=n,{subject:v,cover:{source:l}}=s,{list:m}=d,{list:u=[]}=c,b=m.reduce((e,t)=>{const{encodingOption:{width:r}}=e,{encodingOption:{width:a}}=t;return a>r?t:e}),{source:g}=b;let p={videoSelector:"web",videoURL:g,videoData:{title:v,poster:l,tracks:u.map(e=>{const{source:t,language:r,label:a}=e;return{src:t,kind:"captions",srclang:r,label:a}}),plyrProvider:"html5"},from:"js/vlive.tv/bg/video-detect.js",tabId:r,referer:o,origin:o,strategies:null,headers:t.requestHeaders};await async function(t,r){const a=vlivePremiumContent[r];return void 0!==a?a:(console.warn(`${e}: Requesting the whole page to detect whether content is premium tab=${r}`),!!(await axios.get(t)).data.includes(', "PAID", '))}(o,r)&&(p=deepmerge(p,{videoSelector:"webpage",videoURL:o})),addTabMedia(r,0,p)},{urls:["https://*.apis.naver.com/rmcnmv/rmcnmv/vod/play/v*/*key=*&videoId=*"]},["requestHeaders"])})();