const strategyDict={url:{method:urlStrategy,priority:0},iframe:{method:iframeStrategy,priority:1}},IFRAME_STRATEGY_RUN_IN_TAB=!0;async function resolveStrategy(e){var t,o=!1;const n=[];for(var a of e.videoData.strategies){const{priority:r,method:i}=strategyDict[a];try{t=await i(e),o=!0,twosevenExtLog("resolveStrategy",`Resolved using strategy: ${a}`);break}catch(e){n.push({strategy:a,message:e.message,priority:r}),console.error(e)}}if(!o){const t=n.reduce((e,t)=>e&&e.priority>t.priority?e:t);throw console.warn(`Could not resolve using any of the strategies: ${e.videoData.strategies}`),new Error(t.message)}return t}async function urlStrategy(e){const{videoData:{mediaType:t}}=e,{url:o}=parseVideoURL(e.videoURL),n=JSON.parse(JSON.stringify(e.videoData.headers)),a=await testGetMediaUrl(o,n,!0,1048576);if(a&&a.headers["content-type"].includes("html"))throw new Error("Bad response");return e}async function iframeStrategy(e){const{videoData:t}=e,{fromTabId:o,mediaType:n,shouldMatchMedia:a=!0,topURL:r,referer:i,module:{loadTopURL:s=!1}}=t,d=new URI(s?r:i||r),c=r?new URI(t.topURL):void 0,m="twoseven-strategy-iframe",l=`twoseven-iframe-${m}`,h=`iframe-strategy-${m}`,g=getGroupSettings(SETTINGS.general),{[SETTINGS.general.hideSearchIframe]:u,[SETTINGS.general.showIframeOnWebsites]:w,[SETTINGS.general.loadTopFrameOnWebsites]:p,[SETTINGS.general.mediaSearchDurationSec]:f}=g,b=p.some(e=>d.host().endsWith(e)||d.origin().endsWith(e)),v=!u||b||w.includes(d.host())||w.includes(d.origin())||c&&(w.includes(c.host())||w.includes(c.origin())),y=c&&b?c:d;let S,T,E=!1;if("https"!==d.protocol())try{const e=await axios.get(d.toString());if(200!==e.status)throw new Error(e.data)}catch(e){throw new Error("Page could not be loaded via HTTPS")}return new Promise((t,r)=>{let i;function s({tabId:o,frameId:r,media:s}){if(void 0===i&&console.warn("Ignored tabMedia since iframeTabID was not set"),i===o&&(!a||s.videoData.mediaType===n)){switch(n){case"html5":break;case"hls":if(a){const t=e.videoData.numSegments,o=s.videoData.numSegments;if(o!==t)return void twosevenExtLog(h,`Ignoring media due to numManifestElements mismatch. expected=${t} got=${o}`)}break;case"mpd":default:console.error(`Unimplemented mediaType=${n}`)}e.videoURL=s.videoURL,Object.assign(e.videoData,{tabId:s.tabId,headers:s.headers}),E=!0,g(),t(e)}}function m(){g(!1),tabMediaBus.off("add-tab-media",s);const e=[],t=c||d,o=t.origin(),n=t.toString();return v?e.push(`Adblock extensions may be interfering with our ability to load your video from <span class="has-text-weight-bold">${o}</span>.\n        Please disable them, and refresh your page to try again.\n        If you continue to see this error, please report this website to us and we'll try to get it working.`):e.push(`\n          <p style="text-align: left; margin-top: 1em;">\n            We were not able to load this video automatically.\n            This can happen if the website <span class="has-text-weight-bold">${t.host()}</span> requires you to interact with it before it loads the video or\n            if the website refuses to be embedded. <br>\n            To help the extension find the video, you can go to extension options and do <span class="has-text-weight-bold">one</span> of the following:\n            <ul style="text-align: left; margin-left: 1.5em;">\n              <li>Add <span class="has-text-weight-bold">${o}</span> to the list of websites on which to show frame</li>\n              <li>Uncheck the box <span class="has-text-weight-bold">Hide the frame in which third-party videos are detected</span></li>\n            </ul>\n            <p>\n              In addition, consider increasing the <span class="has-text-weight-bold">Time spent trying to find media</span><br>\n              Once you've made the change, simply refresh your page to try again.\n            </p>\n          </p>`),e.push(`<div style="margin-top: 1em;" class="center has-text-weight-bold">Alternatively, you could also try to <a href="${n}" target="_blank">find the video in a new tab</a></div>`),r(new Error(e.join("<br>")))}function g(e=E){IFRAME_STRATEGY_RUN_IN_TAB?v&&S?browser.windows.remove(S):v||(T?browser.tabs.remove(T):browser.tabs.executeScript(o,{allFrames:!1,code:"document.dispatchEvent(new CustomEvent('twoseven-strategy-complete'))"})):document.dispatchEvent(new CustomEvent("twoseven-strategy-complete")),clearTimeout(u),tabMediaBus.off("add-tab-media",s)}y.addQuery({"twoseven-iframe":l}),tabMediaBus.on("add-tab-media",s);const u=setTimeout(m,1e3*f);if(browser.runtime.onConnect.addListener(e=>{e.name===l&&(twosevenExtLog(h,"Received connection from iframe"),i=getTabIdFromPort(e))}),IFRAME_STRATEGY_RUN_IN_TAB)v?createWindow(y.toString()).then(e=>{S=e.id,browser.windows.onRemoved.addListener(function e(t){t===S&&browser.windows.onRemoved.removeListener(e),E||(S=void 0,g(!1),m())})}):is.firefox()?browser.tabs.create({active:!1},async e=>{browser.tabs.hide(e.id),T=e.id;const t=new Promise(t=>browser.tabs.onUpdated.addListener(function o(n,a){n===e.id&&"complete"===a.status&&(browser.tabs.onUpdated.removeListener(o),t())}));browser.tabs.update(e.id,{url:"https://twoseven.xyz/help/iframe-element"}),await t,await new Promise(t=>browser.tabs.update(e.id,{url:y.toString()},t))}):browser.tabs.executeScript(o,{allFrames:!1,code:`\n              (function () {\n                const evt = 'create-strategy-iframe'\n                twosevenExtLog('${h}', 'Emitting create-strategy-iframe')\n                window.addEventListener('message', function _once ({ data = {} }) {\n                  if (data.action !== evt + '-done') {\n                    return\n                  }\n                  window.removeEventListener('message', _once)\n\n                  const iframe = document.querySelector('#twoseven-strategy-iframe')\n                  const origSrc = iframe.src\n                  iframe.style.display = 'block'\n                  iframe.src = '${y.toString()}'\n\n                  document.addEventListener('twoseven-strategy-complete', function _once () {\n                    document.removeEventListener('twoseven-strategy-complete', _once)\n                    document.body.removeChild(iframe)\n                  })\n                })\n                window.postMessage({action: evt}, '*')\n              })()\n            `,runAt:"document_end"});else{const e=document.createElement("iframe");e.src=y.toString(),e.id=l,e.style.width="1px",e.style.height="1px",document.body.appendChild(e),document.addEventListener("twoseven-strategy-complete",()=>{document.body.removeChild(e)})}})}