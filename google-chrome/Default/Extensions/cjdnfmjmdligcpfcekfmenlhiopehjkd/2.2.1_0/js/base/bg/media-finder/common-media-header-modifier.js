(async()=>{if(!PROCESS_RESPONSE_INTO_MEDIA)return;await mediaFinderReady;const e="common-media-header-modifier",r=window.twoseven.xhrHelp=new PerTabData({name:"xhr-help"}),t={name:`[${e}]: x-twoseven-ext header modifier`,skipOnTwoSeven:!1,check(e){if(getHeaderEntry("x-twoseven-ext",e.requestHeaders))return!0},callback(e){const r=getHeaderEntry("x-twoseven-ext",e.requestHeaders),{value:t}=r;e.requestHeaders.splice(e.requestHeaders.indexOf(r),1);const a=JSON.parse(t);Array.isArray(a)&&e.requestHeaders.push(...JSON.parse(t)),removeHeaderEntry("x-twoseven-ext",e.requestHeaders)}};registerMediaFinder({name:`[${e}]: xhr-helper`,skipOnTwoSeven:!1,check(e){const t=r[e.tabId];return!(!t||!t[e.url])},callback(e){twosevenExtLog(this.name,`Modifying headers for: ${e.url}`);const t=r[e.tabId][e.url];removeHeaderEntry("range",t),e.requestHeaders.push(...t)}},MEDIA_FINDER_LEVELS.ALWAYS_LAST),registerMediaFinder(t),tabReference.on("get-ext-data",(e,t)=>{const a=r[t];r[e]||(r[e]={});var s=r[e];Object.assign(s,a)}),browser.runtime.onConnect.addListener(r=>{if(!r.sender.tab)return;const t=getTabIdFromPort(r);r.onMessage.addListener(async a=>{if(a.to&&a.to===e)switch(a.data.debug,a.action){case"xhr-help":{await addXhrHelpEntry({tabId:t,...a.data});const e=a.data.ack&&a.data.ack.event;e&&r.postMessage({action:e});break}}})}),browser.webRequest.onHeadersReceived.addListener(function(t){let a=!1,s=!1;try{t.initiator&&isOnTwoSeven(t.initiator)||twosevenTabs[t.tabId]?(a=!0,getHeaderValue("x-auth0-requestid",t.responseHeaders)&&(a=!1)):t.initiator===`chrome-extension://${browser.runtime.id}`&&(a=!getHeaderValue("x-auth0-requestid",t.responseHeaders));var n=r[t.tabId];n&&Object.prototype.hasOwnProperty.call(n,t.url)?s=!0:(n=perTabMedia[t.tabId])&&Object.prototype.hasOwnProperty.call(n,t.url)||(a=!1)}catch(e){console.warn(e)}if(a){if(t.statusCode>=300&&t.statusCode<400){const r=getHeaderValue("location",t.responseHeaders);n[r]=n[t.url],twosevenExtLog(e,`Updated xhrHelp to handle redirect: ${t.url} --\x3e ${r}`)}addCORS(t.responseHeaders,"*",t,s),addXFrameOptions(t.responseHeaders)}return{responseHeaders:t.responseHeaders}},{urls:["<all_urls>"]},["blocking","responseHeaders"]);const a=new window.twoseven.LRUCache({max:100,maxAge:3e5});window.addXhrHelpEntry=async function({tabId:e,url:t,topURL:s,headers:n,addCookies:o=!1}){r[e]||(r[e]={});const d=r[e];if(o){const e=new URI(s).domain();let r=a.get(e);if(!r){const t=await window.getCookiesForDomain(e),s=[];for(const e of t){const{name:r,value:t}=e;s.push(Cookie.serialize(r,t))}r=s.join("; "),a.set(e,r)}addHeaderEntry("cookie",r,n)}d[t]=n}})();