let twosevenProfile;const USER_INFO_DOMAIN="twoseven.xyz",authEnv={CLIENT_ID:"7bac8308-7cc0-417d-a85d-945b95aa6ec1",LOGIN_DOMAIN:"twoseven.xyz",OAUTH_DOMAIN:"auth.twoseven.xyz"};var authOpts={scope:"openid profile offline_access email",audience:"extension",device:"chrome-extension",useMain:!0};class CustomAuthClient{constructor(e,t){Object.assign(this,{domain:e,clientId:t})}async authenticate(e={},t=!0){const{domain:s,clientId:o}=this;Object.assign(e,{client_id:o,redirect_uri:this.getRedirectURL(),"cache-buster":Date.now()});const n=`https://${s}/static/html/login/index.html?${qs.stringify(e)}`;console.log(`c-url=${n}`),this.authResultPromise=this.getAuthResult(n,t);const a=await this.authResultPromise,r=new URI(a).search(!0),{id_token:i,refresh_token:c,access_token:u}=r;return{access_token:u,id_token:i,refresh_token:c}}getAuthResult(e,t){return new Deferred((s,o)=>{chrome.identity.launchWebAuthFlow({url:e,interactive:t},e=>{if(chrome.runtime.lastError)return o(new Error(chrome.runtime.lastError.message));s(e)})})}getRedirectURL(){return chrome.identity.getRedirectURL("auth0")}}const authClient=new CustomAuthClient(authEnv.LOGIN_DOMAIN,authEnv.CLIENT_ID);function getAuthResult(){try{return JSON.parse(localStorage.authResult)}catch(e){}}async function authenticate(){try{const e=await authClient.authenticate(authOpts);return localStorage.authResult=JSON.stringify(e),e}catch(e){let t;t="User cancelled or denied access"===e.message?e.message.replace(/User/,"You"):e.message,browser.notifications.create({type:"basic",title:"Login Failed",message:t,iconUrl:"icons/icon-64x64.png"})}}function isAuthTokenValid(e){try{return jwt_decode(e).exp>Date.now()/1e3}catch(e){return!1}}async function getUserInfo(e,t=!1){let s=JSON.parse(localStorage.profile||"{}");const{lastUpdated:o=0}=s;if(0===Object.keys(s).length||t||Date.now()-o>3e4)try{return(s=(await axios.get(`https://${USER_INFO_DOMAIN}/api/userinfo`,{headers:{Authorization:`Bearer ${e.access_token}`}})).data).lastUpdated=Date.now(),localStorage.profile=JSON.stringify(s),twosevenProfile=s,s}catch(e){s=null,twosevenProfile=void 0,delete localStorage.profile,delete localStorage.authResult}return s}async function refreshTokens(e){e||(e=getAuthResult());const t={grant_type:"refresh_token",client_id:authEnv.CLIENT_ID,refresh_token:e.refresh_token},s=await axios.post(`https://${authEnv.OAUTH_DOMAIN}/oauth2/token`,null,{params:t}),{data:{access_token:o,id_token:n}}=s;return Object.assign(e,{access_token:o,id_token:n}),localStorage.authResult=JSON.stringify(e),e}async function refreshTokensIfNeeded(e=10800){const t=getAuthResult(),{access_token:s}=t,{exp:o}=jwt_decode(s);o-Date.now()/1e3<e&&await refreshTokens()}function logout(){localStorage.removeItem("authResult"),localStorage.removeItem("profile")}(async()=>{async function e(){const e=getAuthResult()||{},{access_token:t}=e;t&&(isAuthTokenValid(t)||await refreshTokens(e),await getUserInfo(e,!0))}browser.runtime.onConnect.addListener(t=>{t.onMessage.addListener(async s=>{if(s.to&&"auth-bg"===s.to)switch(s.action){case"twoseven-profile":await e(),t.postMessage({to:s.from,action:"twoseven-profile",profile:twosevenProfile});break;case"authenticate":authenticate().then(e=>{getUserInfo(e).then(s=>{t.postMessage({to:"browser-action",action:"login-success",authResult:e,profile:s})})});break;case"credentials":{let e,s=getAuthResult();try{s&&!isAuthTokenValid(s.access_token)&&(s=await refreshTokens(s)),s&&(e=await getUserInfo(s))}catch(e){}t.postMessage({to:"browser-action",action:"login-success",authResult:s,profile:e});break}case"logout":logout()}})}),is.firefox()&&browser.webRequest.onBeforeSendHeaders.addListener(e=>{const{tabId:t,url:s}=e,o=setTimeout(async()=>{authClient.authResultPromise.resolve(s),browser.tabs.remove(t)},5e3);browser.tabs.onRemoved.addListener(function e(s){s===t&&(clearTimeout(o),browser.tabs.onRemoved.removeListener(e))})},{urls:[`${browser.identity.getRedirectURL()}*`]}),e()})();