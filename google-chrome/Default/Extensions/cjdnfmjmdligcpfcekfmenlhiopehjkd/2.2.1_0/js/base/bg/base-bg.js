const contextMenuIds={},onBeforeNavigateListeners=new PrioritizedCallbacks("onBeforeNavigate");async function getClientID(e){return new Promise((t,n)=>{browser.storage.sync.get("clientID",function(n){var{clientID:o}=n;if(o&&!e)return t(o);o=uuid.v4(),browser.storage.local.set({clientID:o},function(){browser.storage.sync.set({clientID:o},function(){return t(o)})})})})}function getCurrentTab(){return getTab({active:!0,currentWindow:!0})}async function getTab(e){return new Promise((t,n)=>{browser.tabs.query(e,function(e){const n=e[0];t(n)})})}async function getTabByTabId(e){return new Promise((t,n)=>{browser.tabs.get(e,t)})}function addContextMenuEntry(e,t,n){const o={title:"Watch on twoseven.xyz",contexts:["page"],documentUrlPatterns:t,onclick:function(){browser.tabs.create({url:`https://twoseven.xyz/ext-media?tabId=${e}&hash=${n.videoData.hash}`})}},s=contextMenuIds[e]?contextMenuIds[e].menuId:void 0;if(s)browser.contextMenus.update(s,o);else{const t=browser.contextMenus.create(o);contextMenuIds[e]={menuId:t}}contextMenuIds[e].data=n}!function(){function e(e,t){const n=contextMenuIds[e];n&&(delete contextMenuIds[e],browser.contextMenus.remove(n.menuId))}browser.tabs.onRemoved.addListener(e),browser.tabs.onUpdated.addListener(function(t,n,o){if(void 0===n.url)return e(t)})}(),function(){for(var e,t,n,o="base-bg",s=["netflix","einthusan"],a={},r={},i={"twoseven.xyz-communicator":{onConnect:[],onMessage:[function(s,a){const r=getTabIdFromPort(a);switch(s.type){case"leave-room-page":twosevenExtLog(o,"leave-room-page"),e&&e.disconnect(),twosevenTabsLRUCache.del(r),delete twosevenTabs[r],e=void 0,t=void 0;break;case"join-room-page":n=s.href,t=s.roomName,twosevenExtLog(o,`join-room-page: ${t}`),twosevenTabsLRUCache.set(r,s),twosevenTabs[r]=s;break;case"sourceChange":Object.assign(twosevenTabs[r],{videoSelectors:s.data});break;case"retry-msg":setTimeout(()=>{var e=s.msg,t=e._socket_event;delete e._socket_event,v(t,e),twosevenExtLog(o,`Retrying message to ${e.videoSelector}`)},500)}}]}},c=0;c<s.length;c++){i[s[c]]={onConnect:[w],onMessage:[b]}}function d(e,t){e.postMessage({from:o,action:"tab-update",isPausedOnWebsite:isPausedOnWebsite(t.url),isPausedOnAllWebsites:isPausedOnAllWebsites()})}function b(e,s){switch(twosevenExtLog(o,JSON.stringify(e)),e.type){case"get-page-info":var a=Object.assign(e,{roomName:t,href:n});s.postMessage(a)}}async function u({tab:e,id:t,tabId:n,url:o}){if(void 0!==t&&void 0===n&&(n=t),o||void 0===n||(e=await new Promise(e=>browser.tabs.get(n,e))),void 0===n&&(n=e.id),o||(o=e.url),!o)return;tabURLs[n]=o;const s=getBrowserActionIcon(o);browser.browserAction.setIcon({path:s,tabId:n})}function v(e,t){var n;if(twosevenExtLog(o,`Received socket.io event [${e}]: ${JSON.stringify(t)}`),"media-update"!==e){if(!(n=function(e){return r[e.videoSelector]}(t)))return void twosevenExtLog(o,`No ports found for videoSelector=${t.videoSelector}`)}else{n=[];for(var s=Object.keys(r),i=0;i<s.length;i++)n=n.concat(r[s[i]]);0===n.length&&(n=a["twoseven.xyz-communicator"],t._socket_event=e)}!function(e,t,n){for(var o=0;o<t.length;o++){var s=t[o];n.eventName=e,n.from="base-bg";try{s.postMessage(n)}catch(e){}}}(e,n,t)}function w(t){var n=t.name;r[n]||(r[n]=[]);var s=new Set(getVideoshareEvents());r[n]=[t],t.onMessage.addListener(t=>{var n=t.eventName;s.has(n)&&(delete t.eventName,twosevenExtLog(o,`socket.emit('${n}', ${JSON.stringify(t)})`),e.emit(n,t))}),t.onDisconnect.addListener(()=>{r[t.name]&&r[t.name].splice(r[t.name].indexOf(t),1)})}i["browser-action"]={onConnect:[],onMessage:[async function(e,t){const n=await getCurrentTab(),s=n.id;switch(e.action){case"version":t.postMessage({from:o,to:e.from,action:e.action,version:getVersion()});break;case"tab-info":t.postMessage({from:o,to:e.from,action:e.action,url:n.url,tabMedia:sanitizeObject(perTabMedia[s])}),d(t,n);break;case"open-twoseven.xyz":browser.tabs.create({url:"https://twoseven.xyz/"});break;case"show-tab-media":showTabMediaOnTab(n),d(t,n);break;case"pause-on-website":pauseOnWebsite(n.url,e.shouldPause),d(t,n),updateBrowserActionIcon();break;case"pause-on-all-websites":pauseOnAllWebsites(e.shouldPause),d(t,n),updateBrowserActionIcon();break;case"last-twoseven-tab":t.postMessage({from:o,to:e.from,action:e.action,lastActiveTwoSevenTabId:twosevenTabsLRUCache.getLatestTab()})}}]},onBeforeNavigateListeners.addListener(({tabId:e,url:t,frameId:n})=>{0===n&&u({tabId:e,url:t})},PrioritizedCallbacks.Levels.ALWAYS_FIRST),browser.tabs.onActivated.addListener(u),browser.tabs.onUpdated.addListener((e,t,n)=>{const{status:o}=t;"complete"===o&&u(n)}),browser.tabs.onRemoved.addListener(e=>{delete twosevenTabs[e],delete tabURLs[e],twosevenTabsLRUCache.del(e)}),browser.webNavigation.onBeforeNavigate.addListener((...e)=>{const{listeners:t}=onBeforeNavigateListeners;t.forEach(t=>t(...e))}),browser.runtime.onConnect.addListener(e=>{if(i[e.name]){var t;if(a[e.name]||(a[e.name]=[]),twosevenExtLog(o,`Received connection from: ${e.name}`),a[e.name].push(e),t=i[e.name].onConnect)for(var n=0;n<t.length;n++)t[n](e);if(t=i[e.name].onMessage){for(n=0;n<t.length;n++){var s=t[n];e.onMessage.addListener(s)}twosevenExtLog(o,`Setup ${t.length} listeners for ${e.name}`)}e.onDisconnect.addListener(()=>{a[e.name].splice(a[e.name].indexOf(e),1)})}}),browser.runtime.onConnect.addListener(e=>{e.onMessage.addListener(async t=>{const{action:n}=t,{name:o}=e,s=getTabIdFromPort(e),a=await getTabByTabId(s),{url:r}=a,{sender:{frameId:i}}=e;switch(n){case"frame-identity":e.postMessage({action:"frame-identity",name:o,tabId:s,frameId:i,topURL:r});break;case"get-clientID":e.postMessage({action:"get-clientID",clientID:await getClientID()})}})}),browser.runtime.onMessage.addListener(async(e,t)=>{try{const{action:n}=e;switch(n){case"ext-navigate":{const{tabId:t,frameId:n,location:o,newTab:s=!1}=e;s?browser.tabs.create({url:o}):browser.tabs.executeScript(t,{frameId:n,code:`window.location.href = '${o}'`});break}case"is-on-twoseven-tab":{const{tab:{id:e},frameId:n}=t;browser.tabs.executeScript(e,{frameId:n,code:`triggerEvent(window, 'is-on-twoseven-tab-response', JSON.stringify({ isOnTwoSevenTab: ${!!twosevenTabs[e]} }), true)`});break}case"clear-cache":{const{tab:{id:n},frameId:o}=t,{data:{origins:s},ack:a}=e;try{browser.browsingData.removeCache({since:Date.now()-864e5,origins:s},()=>{browser.tabs.executeScript(n,{frameId:o,code:`triggerEvent(window, '${a}')`})})}catch(e){}}}}catch(e){}})}();