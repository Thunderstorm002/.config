async function getFacebookVideoURL(e){return(await axios.get("https://twoseven.xyz/api/url-finder/facebook",{params:{url:e}})).data}window.twoseven.facebook={};const liveURLCache=window.twoseven.facebook.liveURLCache=new window.twoseven.LRUCache({max:100});async function getFacebookLiveURL(e,t){let a=liveURLCache.get(t);if(!a){const o=await axios.post("https://twoseven.xyz/api/url-finder/facebook-live",{data:e});liveURLCache.set(t,o.data),a=o.data}return a}!function(){browser.runtime.onConnect.addListener(e=>{"fb-media-finder"===e.name&&e.onMessage.addListener(async t=>{const a=getTabIdFromPort(e),o=e.sender.frameId;switch(t.action){case"found-media":{const{url:e}=t,{url:r,title:i}=await getFacebookVideoURL(e);if(!r)return;addTabMedia(a,o,{videoSelector:"web",videoURL:r,videoData:{plyrProvider:"html5",plyrType:"video",plyrContentType:"video/mp4",title:i},from:"facebook/media-finder-bg.js",referer:e,origin:e,strategies:["url"],headers:[]});break}}})});const e=window.twoseven.facebook.metadataCache=new window.twoseven.LRUCache({max:100});browser.webRequest.onBeforeSendHeaders.addListener(t=>{const{url:a,tabId:o,frameId:r}=t;if(twosevenTabs[o])return;const i=new URI(a);i.query(!0)["ts-bypass"]||(async()=>{i.addQuery({"ts-bypass":1});const t=i.search(!0).video_id;let n,s=e.get(t);s||(s=await evaluateOnPageAndGetResponse(async function(){const e=await fetch(a);return await e.text()},o,r,[{pattern:/url/g,replacement:`'${i.toString()}'`}],5e3))&&e.set(t,s);try{n=JSON.parse(s.substring(9))}catch(e){n=await getFacebookLiveURL(s,t)}if(!n)return;const{payload:{hd_src:d,sd_src:c,is_hls:l=!1,stream_type:f,video_url:w}}=n;for(let[e,t]of Object.entries({hd:d,sd:c})){if(!t)continue;"dash"===f||t.includes("mpd")?t=`mpd:${t}`:(l||"hls"===f||t.includes("m3u8"))&&(t=`hls:${t}`);const i={videoSelector:"web",videoURL:t,videoData:{plyrProvider:"html5",plyrType:"video",plyrContentType:"video/mp4",title:`${w} (${e.toUpperCase()})`},from:"facebook/media-finder-bg.js",referer:a,origin:a,strategies:["url"],headers:[]};addTabMedia(o,r,i)}})()},{urls:["https://*.facebook.com/video/video_data_async/*"]},["requestHeaders"])}();