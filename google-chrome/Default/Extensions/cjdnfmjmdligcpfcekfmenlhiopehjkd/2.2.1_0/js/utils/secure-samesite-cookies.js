const twosevenCookies={},cookieEvents=new Emittery;(async()=>{const e="[secure-samesite-cookies]",o=[new RegExp("https://play.hulu.com/license/.*")];async function s({path:e,value:o}){switch(e){case SETTINGS.general.sameSiteDomains:{const e=new Set(o);for(const o of Object.keys(twosevenCookies))e.has(o)||delete twosevenCookies[o];for(const e of[...o])twosevenCookies[e]||await w(e);break}case SETTINGS.general.sameSiteOverride:for(const e of[...o])await d(e)}}async function t(e){const o=`.${e}`,s=SETTINGS.general.sameSiteDomains,{[s]:t}=settings;if(!t.includes(o)){const e=[...t,o];settings[s]=e,await PolyfilledStorage.local.set({[SETTINGS.general.sameSiteDomains]:e})}}async function n(){for(const e of settings[SETTINGS.general.sameSiteDomains])settings[SETTINGS.general.sameSiteOverride]&&await d(e),await w(e)}function i(e,o=!1){let s=e;s.startsWith(".")&&(s=s.slice(1));const t=new URI(`https://${s}`);return`.${o?t.domain():t.host()}`}function a(e){const o=i(e);return settings[SETTINGS.general.sameSiteDomains].includes(o)}function r(e){const{name:o,value:s,domain:t,path:n,httpOnly:a,expirationDate:r,storeId:c,url:d}=e,m={url:d||`https://${i(t)}`,name:o,value:s,domain:t,path:n,secure:!0,httpOnly:a,sameSite:browser.cookies.SameSiteStatus.NO_RESTRICTION,expirationDate:r,storeId:c};return new Promise((o,s)=>browser.cookies.set(m,n=>n?o():s(new Error(`Failed to set cookie: domain=${t} cookie=${JSON.stringify(e)}`))))}function c(e){return new Promise(o=>browser.cookies.getAll({domain:e},o))}async function d(e){const o=await c(e);for(const e of o)r(e)}async function m(e,o){const{name:s,value:t}=o;twosevenCookies[e][s]=t}async function w(e){twosevenCookies[e]||(twosevenCookies[e]={});const o=await c(e);for(const s of o)await m(e,s)}async function u({removed:o,cookie:s}){const{name:t,domain:n,sameSite:c,secure:d}=s;if(cookieEvents.emit("update",{removed:o,cookie:s}),!a(n)||c===browser.cookies.SameSiteStatus.NO_RESTRICTION&&d)return;const w=i(n);if(o)try{delete twosevenCookies[w][t]}catch(e){}else settings[SETTINGS.general.sameSiteOverride]&&(await r(s),twosevenExtLog(e,`Modified a cookie from domain: ${n} (${t})`)),await m(w,s)}async function l(){settings.on("change",s),browser.cookies.onChanged.addListener(u),twosevenExtLog(e,"Set up all handlers")}window.addToSameSiteDomains=t,window.resyncTwoSevenCookieStore=n,browser.runtime.onMessage.addListener(async(e,{tab:o,frameId:s})=>{const{action:n,data:i}=e,{id:a}=o;switch(n){case"add-to-same-site":{const{domain:e,tabId:o,frameId:s,reloadFrame:n=!1,reloadTab:a=!1}=i;await t(e),a?browser.tabs.executeScript(o,{code:"window.location.reload(true)"}):n&&browser.tabs.executeScript(o,{frameId:s,code:"window.location.reload(true)"});break}case"same-site-notification":{const{url:e,domain:o=new URI(e).domain()}=i,t=`.${o}`;if(settings[SETTINGS.general.sameSiteDomains].includes(t))return;toast({msg:`This website may need to be added to the extension's SameSite bypass list.\n          <a class="toast-close" onclick="triggerEvent(window, 'ts:relay-bg', JSON.stringify({ realAction: 'add-to-same-site', data: { domain: '${o}', tabId: ${a}, frameId: ${s}, reloadTab: true } }), true)">Click here</a> to add it and reload this page.`,delay:3e4},a)}}}),window.checkCookies=async function(o){const s={},t={},n={},a={};o=i(o);const r=await c(o),d=twosevenCookies[o];for(const e of r){const{name:o,value:t}=e,i=d[o];void 0===i?s[o]=t:i!==t?n[o]={store:t,twoseven:i}:a[o]=t}const m=new Set(r.map(e=>e.name)),w=Object.keys(d).filter(e=>!m.has(e));for(const e of w)t[e]=d[e];twosevenExtLog(e,`missing: ${JSON.stringify(s,null,2)}`,"warning"),twosevenExtLog(e,`extra: ${JSON.stringify(t,null,2)}`,"brown"),twosevenExtLog(e,`different: ${JSON.stringify(n,null,2)}`,"red"),twosevenExtLog(e,`same: ${JSON.stringify(a,null,2)}`,"green")},window.shouldModifyDomain=a,window.getTwoSevenCookies=function(e){const o=i(e);return twosevenCookies[o]},window.getCookiesForDomain=c,browser.runtime.onConnect.addListener(async e=>{if("samesite-cookies"!==e.name)return;const o=async({domain:e,subDomain:o})=>{const s=await c(o),t=s;if(!s||0===Object.keys(s).length){const o=await c(e);Object.assign(t,o)}return t},s=async({cookie:{domain:s}})=>{if(!s.includes(e.__data.domain))return;const t=await o(e.__data);e.postMessage({action:"samesite-cookies",cookies:t})};e.onDisconnect.addListener(()=>{cookieEvents.off("update",s)}),e.onMessage.addListener(async s=>{if("samesite-cookies"!==s.action)return;const{url:t}=s,n=new URI(t),i=n.domain(),a=n.subdomain();let r=a;a&&(r+=`.${i}`);const c=await o({domain:i,subDomain:r});e.postMessage({action:"samesite-cookies",cookies:c}),Object.assign(e,{__data:{domain:i,subDomain:r}})})}),await settingsReady,is.chrome()&&(browser.permissions.onAdded.addListener(({permissions:e})=>{e.includes("cookies")&&l()}),browser.permissions.onRemoved.addListener(({permissions:o})=>{o.includes("cookies")&&async function(){settings.off("change",s),browser.cookies.onChanged.removeListener(u);for(const e of Object.keys(twosevenCookies))delete twosevenCookies[e];twosevenExtLog(e,"Removed all handlers")}()})),await new Promise(e=>browser.permissions.contains({permissions:["cookies"],origins:["<all_urls>"]},e))&&l();const f=["blocking","requestHeaders"];is.chrome(">=72")&&f.push("extraHeaders"),browser.webRequest.onBeforeSendHeaders.addListener(e=>{const{tabId:s,frameId:t}=e;if(0!==t&&twosevenTabs[s]&&!settings[SETTINGS.general.sameSiteOverride]){if(o.some(o=>e.url.match(o)))return{requestHeaders:e.requestHeaders};try{let o,s,t=!0;e.initiator&&"twoseven.xyz"!==(s=(o=new URI(e.initiator)).domain())&&(t=!1),t&&(s=(o=new URI(e.url)).domain());const n=i(s);if(!a(n))return{requestHeaders:e.requestHeaders};const r=twosevenCookies[n];if(r){const o=function(e){if("string"!=typeof e)throw new TypeError("argument str must be a string");for(var o={},s=e.split(/; */),t=0;t<s.length;t++){var n=s[t],i=n.indexOf("=");if(!(i<0)){var a=n.substr(0,i).trim(),r=n.substr(++i,n.length).trim();void 0===o[a]&&(o[a]=r)}}return o}(getHeaderValue("cookie",e.requestHeaders)||""),s=new Set([...Object.keys(r),...Object.keys(o)]),t={};for(const e of[...s]){const s=r[e],n=o[e];window.debug&&s!==n&&void 0!==n&&console.warn(`Cookie varies: key=${e} twoseven=${s} req=${n}`),t[e]=void 0===n?s:n}const n=[];for(const e of Object.keys(t)){const o=t[e];n.push(`${e}=${o}`)}addHeaderEntry("cookie",n.join("; "),e.requestHeaders)}}catch(e){console.error(e)}return{requestHeaders:e.requestHeaders}}},{urls:["<all_urls>"]},f);const g=["blocking","responseHeaders"];is.chrome(">=72")&&g.push("extraHeaders"),await n()})();