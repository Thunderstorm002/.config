const browser=chrome||browser;let twosevenScriptsDiv=document.createElement("div");function injectScript(e,t,n){var o=document.createElement("script"),s=`__tmpScript-${1e9*Math.random()|0}`;o.type="text/javascript",o.id=n||s,o.dataset.addedByTwoSeven="1",o.text=`(function() {\n    ${e};\n  })();`,t&&(o.text+=`(function() {\n      var elem = document.getElementById('${s}');\n      elem.parentNode.removeChild(elem);\n    })();`),(twosevenScriptsDiv||document.head||document.body||document.documentElement).appendChild(o)}function injectScriptByURL(e,t,n=twosevenScriptsDiv,o=!0){var s=document.createElement("script");s.type="text/javascript",s.id=t||`__tmpScript-${1e9*Math.random()|0}`,s.src=e,s.async=!1,s.defer=!1,s.dataset.addedByTwoSeven=o?"1":"0",(n||document.head||document.body||document.documentElement).appendChild(s)}function injectStylesheet(e,t,n){const o=document.createElement("style");o.id=t||"__tmpStyle",o.innerHTML=e,(n||document.head).appendChild(o)}function injectStylesheetByURL(e,t,n){const o=document.createElement("link");o.href=e,o.rel="stylesheet",o.id=t||"__tmpStyle",(n||document.head).appendChild(o)}async function waitForDOMNode(e,t=document){e=e||{};const{type:n,value:o}=e;if(!n||!o)throw new Error("Must specify identifier");let s=o;switch(n){case"tag":s=o.toUpperCase()}if("check"!==n){const e=await i({type:"selector",value:s},[],t);if(e)return new Promise(t=>t(e))}async function i({type:e,value:t},n,o){let s;switch(e){case"tag":s=n.find(e=>e.tagName===t);break;case"selector":s=o.querySelector(t);break;case"check":for(const e of n){if(await t(e))return e}}return s}return new Promise((e,o)=>{const r=new MutationObserver(async o=>{for(const a of o)if("childList"===a.type){const o=Array.from(a.addedNodes),c=await i({type:n,value:s},o,t);if(c)return r.disconnect(),e(c)}});r.observe(t,{childList:!0,subtree:!0})})}function reportError(e,t,n){"string"==typeof(n=n||{})&&(n={message:n});const{message:o,stack:s}=t;Object.assign(n,{tag:e,error:{message:o,stack:s}}),window.tsExtGetPostToParent()({name:name,tag:e,action:"report-error",json:n}),console.error(JSON.stringify(n.error))}function postMessageToPort(e,t){t.name=e.name,e.postMessage(t)}async function postTo(e,t,n=!1){let o;return t.name=t.name||name,o=n?new Promise(e=>{const n=`ack-${t.action}-${1e9*Math.random()|0}`;t.ack={event:n};window.debug&&["play","pause","currentTime"].some(e=>t.action.includes(e)),window.addEventListener("message",function t({data:o={}}){o.action===n&&(window.removeEventListener("message",t),e(o.json))})}):new Promise(e=>e()),e.postMessage(t,"*"),o}function tsExtGetPostTo(){return window.twoseven&&window.twoseven.postTo||window.postTo}function tsExtGetPostToParent(){return window.twoseven&&window.twoseven.postToParent||window.postToParent}async function postResponse(e,t){const{source:n,data:{ack:{event:o}}}=e;window.tsExtGetPostTo()(n,{action:o,json:t})}async function postToParent(e,t=!1){return window.tsExtGetPostTo()(window.parent,e,t)}async function postToTop(e,t=!1){return window.tsExtGetPostTo()(window.top,e,t)}function attachHistoryListeners(){var e=history.pushState;history.pushState=function(t,n,o){return"function"==typeof history.onpushstate&&history.onpushstate({state:t}),triggerEvent(window,"pushstate",{uri:o}),e.apply(history,arguments)};var t=history.replaceState;history.replaceState=function(e){return"function"==typeof history.onreplacestate&&history.onreplacestate({state:e}),t.apply(history,arguments)}}function once(e,t,n){e.addEventListener(t,function o(s){e.removeEventListener(t,o),n(s)})}function checkIsOnTwoSevenViaPort(e){return new Promise(t=>{e.onMessage.addListener(function n(o){const{action:s,value:i=!1}=o;if("is-on-twoseven"===s)return e.onMessage.removeListener(n),t(i)}),e.postMessage({action:"is-on-twoseven"})})}function getSettingsViaPort(e){return new Promise(t=>{e.onMessage.addListener(function n(o){const{action:s,settings:i,keys:r}=o;if("get-settings"===s)return e.onMessage.removeListener(n),t({settings:i,keys:r})}),e.postMessage({action:"get-settings"})})}function getClientIDViaPort(e){return new Promise(t=>{e.onMessage.addListener(function n(o){const{action:s,clientID:i}=o;if("get-clientID"===s)return e.onMessage.removeListener(n),t(i)}),e.postMessage({action:"get-clientID"})})}function logAllVideoEvents(e,t){const n=["abort","canplay","canplaythrough","durationchange","ended","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting"],o={};for(const s of n){const n=()=>twosevenExtLog(t,s);o[s]=n,e.addEventListener(s,n)}e.__logAllVideoEventsMap=o}function stopLoggingVideoEvents(e){const{__logAllVideoEventsMap:t}=e;if(t){for(const[n,o]of Object.entries(t))e.removeEventListener(n,o);delete e.__logAllVideoEventsMap}}function waitForVideoReady(e){let t,n;return new Promise(o=>{const s=()=>{t=!0},i=()=>{t=!1},r=()=>{n=!0},a=()=>{!t&&n&&(e.removeEventListener("waiting",s),e.removeEventListener("canplaythrough",i),e.removeEventListener("playing",r),e.removeEventListener("progress",a),o())};e.addEventListener("waiting",s),e.addEventListener("canplaythrough",i),e.addEventListener("playing",r),e.addEventListener("progress",a)})}function sendMessageToBG(e,t,n){const o=`event-${1e8*Math.random()|0}`;return new Promise(s=>{once(window,o,()=>{n&&n(),s()}),browser.runtime.sendMessage({action:e,data:t,ack:o})})}twosevenScriptsDiv.style.cssText="\ndisplay: none !important;\nvisibility: invisible !important;\nposition: static !important;\ntop: 0 !important;\nleft: 0 !important;\nwidth: 0px !important;\nheight: 0px !important;\n",twosevenScriptsDiv.id="twoseven-scripts",twosevenScriptsDiv.dataset.info="Scripts added by TwoSeven extension",window.twosevenScriptsDiv=twosevenScriptsDiv,document.documentElement.appendChild(twosevenScriptsDiv),injectScript("window.twoseven = {}"),injectScript(`window.twoseven.waitForDOMNode = ${waitForDOMNode.toString()}`),injectScript(`\n  window.twoseven.reportError = ${reportError.toString()}\n`),window.twoseven.reportError=reportError,injectScript("\n  window.twosevenHmsToSecondsOnly = function(str) {\n      var p = str.split(':'),\n          s = 0, m = 1;\n\n      while (p.length > 0) {\n          s += m * parseInt(p.pop(), 10);\n          m *= 60;\n      }\n\n      return s;\n  }\n"),injectScript(`window.twosevenExtLog = ${window.twosevenExtLog.toString()}`),injectScript("\n  document.twosevenGET = function(url, callback) {\n    var xmlhttp = new XMLHttpRequest();\n\n    xmlhttp.onreadystatechange = function() {\n      if (xmlhttp.readyState == XMLHttpRequest.DONE ) {\n        if (xmlhttp.status == 200) {\n          callback(null, xmlhttp.responseText);\n        } else {\n          callback('something else other than 200 was returned', '');\n        }\n      }\n    };\n    xmlhttp.open(\"GET\", url, true);\n    xmlhttp.send();\n  };\n"),window.triggerEvent=function(e,t,n,o=!1){let s;o?(n&&"string"!=typeof n&&(n=JSON.stringify(n)),s=n):s={data:n},window.twosevenScriptsDiv&&n&&"object"==typeof n&&(console.warn(`WARNING: Attempting to send an object via event.detail from CS->Page does not work on Firefox: ${JSON.stringify(n)}`),console.error((new Error).stack));var i=new CustomEvent(t,{bubbles:!0,composed:!0,detail:s});e.dispatchEvent(i)},injectScript(`\n  window.triggerEvent = ${window.triggerEvent.toString()}\n`),window.postTo=postTo,injectScript(`window.twoseven.postTo = ${postTo.toString()}`),window.tsExtGetPostTo=tsExtGetPostTo,injectScript(`window.tsExtGetPostTo = ${tsExtGetPostTo.toString()}`),window.tsExtGetPostToParent=tsExtGetPostToParent,injectScript(`window.tsExtGetPostToParent = ${tsExtGetPostToParent.toString()}`),injectScript(`window.twoseven.postResponse = ${postResponse.toString()}`),window.postToParent=postToParent,injectScript(`window.twoseven.postToParent = ${postToParent.toString()}`),window.postToTop=postToTop,injectScript(`window.twoseven.postToTop = ${postToTop.toString()}`),window.addEventListener("get-from-storage",e=>{const{detail:{data:{key:t,evt:n}}}=e;browser.storage.local.get(t,e=>{const{[t]:o}=e;triggerEvent(window,n,{value:o})})}),window.addEventListener("save-to-storage",e=>{const{detail:{data:t}}=e;browser.storage.local.set(t)}),window.twoseven.getFromStorage=(e=>new Promise((t,n)=>{const o="get-from-storage-"+(1e9*Math.random()|0);window.addEventListener(o,e=>{window.removeEventListener(o,this);const{detail:{data:{value:n}}}=e;t(n)}),triggerEvent(window,"get-from-storage",{key:e,evt:o})})),window.twoseven.saveToStorage=(e=>{triggerEvent(window,"save-to-storage",e)}),injectScript(`\n  window.twoseven.getFromStorage = ${window.twoseven.getFromStorage.toString()}\n  window.twoseven.saveToStorage = ${window.twoseven.saveToStorage.toString()}\n`),injectScript(`\n  ${attachHistoryListeners.toString()}\n  attachHistoryListeners()\n`),injectScript(`window.twoseven.once = ${once.toString()}`),window.twoseven.toast=(({msg:e,delay:t})=>{postToParent({action:"generic-toast",json:{msg:e,delay:t}})}),window.addEventListener("ext-open-settings",()=>{browser.runtime.sendMessage({action:"open-settings"})}),window.addEventListener("ext-navigate",e=>{const{detail:{data:t}}=e;browser.runtime.sendMessage({...t,action:"ext-navigate"})}),window.addEventListener("ts:relay-bg",e=>{try{const{detail:t}=e,n=JSON.parse(t),{realAction:o,data:s}=n;twosevenExtLog(`Relaying message to bg: ${o}`),browser.runtime.sendMessage({action:o,data:s})}catch(e){}}),window.twoseven.isOnTwoSevenTab=(async()=>{const e=new Deferred;return window.addEventListener("is-on-twoseven-tab-response",function t(n){window.removeEventListener("is-on-twoseven-tab-response",t);const o=JSON.parse(n.detail);e.resolve(o.isOnTwoSevenTab)}),browser.runtime.sendMessage({action:"is-on-twoseven-tab"}),e}),window.addEventListener("message",async e=>{const{data:{action:t}}=e;"is-on-twoseven-tab"===t&&postResponse(e,await window.twoseven.isOnTwoSevenTab())}),injectScript("\n  window.twoseven.isOnTwoSevenTab = async () => {\n    const result = await window.twoseven.postTo(window, { action: 'is-on-twoseven-tab' }, true)\n    return result\n  }\n"),window.twoseven.isPaused=(async()=>{const e=new Deferred;return window.addEventListener("twoseven:pause-state-response",function t(n){window.removeEventListener("twoseven:pause-state-response",t);const o=JSON.parse(n.detail);e.resolve(o.isPaused)}),browser.runtime.sendMessage({action:"pause-state"}),e}),window.addEventListener("message",async e=>{const{data:{action:t}}=e;"twoseven:pause-state"===t&&postResponse(e,await window.twoseven.isPaused())}),injectScript("\n  window.twoseven.isPaused = async () => {\n    const result = await window.twoseven.postTo(window, { action: 'twoseven:pause-state' }, true)\n    return result\n  }\n");