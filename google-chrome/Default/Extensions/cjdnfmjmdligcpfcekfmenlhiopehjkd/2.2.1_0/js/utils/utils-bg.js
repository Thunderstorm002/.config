const browser=chrome||window.browser;function getHeaderEntry(e,t){var n;return t.forEach(t=>{t.name&&t.name.toLowerCase()===e.toLowerCase()&&(n=t)}),n}function getHeaderValue(e,t){const n=getHeaderEntry(e,t);if(n)return n.value}function addHeaderEntry(e,t,n){const r=getHeaderEntry(e,n);r?r.value=t:n.push({name:e,value:t})}function webRequestHeadersToObject(e){const t={};return e.forEach(({name:e,value:n})=>{t[e]=n}),t}function removeHeaderEntry(e,t){const n=getHeaderEntry(e,t),r=t.indexOf(n);r>=0&&t.splice(r,1)}function addCORS(e,t="*",n={},r=!1){if(n.initiator){const r=new URL(n.initiator).origin,s=getHeaderValue("access-control-allow-origin",e);"*"!==s&&r===s&&(t=r)}const s=getHeaderValue("access-control-allow-credentials",e);if(!r&&"true"===s)return;addHeaderEntry("Vary","Origin",e);addHeaderEntry("access-control-allow-origin",t,e)}function addXFrameOptions(e,t){const n="x-frame-options",r=getHeaderEntry(n,e);if(t)r?r.value=t:e.push({name:n,value:t});else if(r){var s=e.indexOf(r);-1!==s&&e.splice(s,1)}}function setupCacheBuster(e,t){browser.webRequest.onBeforeRequest.addListener(e=>{const n=new URI(e.url);if(n.query(!0)["ts-uuid"])return;const r=uuid();return n.addQuery({"ts-uuid":r}),twosevenExtLog(t,`Busted cache on url: ${e.url}`),{redirectUrl:n.toString()}},{urls:e},["blocking"]),twosevenExtLog("utils-bg",`Set up cacheBuster for ${t}`)}function getTabIdFromPort(e){return e.sender.tab&&e.sender.tab.id||-1}async function testGetMediaUrl(e,t={},n=!0,r=0){try{const s=axios.CancelToken.source(),o=await axios.get(e,{headers:{"x-twoseven-ext":JSON.stringify(t)},responseType:"arraybuffer",cancelToken:s.token,onDownloadProgress:e=>n&&(e.total>=r||e.loaded>=r)?s.cancel("working"):e.currentTarget.status<200||e.currentTarget.status>=400?s.cancel("failed"):void 0});if(200!==o.status)throw new Error(`URL strategy failed: ${o.data}`);return o}catch(e){if(!axios.isCancel(e)||"failed"===e.message)throw new Error(`URL strategy failed: ${e.message}`)}}function assuredSend(e,t,n){var r=e[t];if(r&&0!==r.length){twosevenExtLog("utils-bg","Sending to "+t+" msg: "+JSON.stringify(n));for(var s=0;s<r.length;s++)try{r[s].postMessage(JSON.stringify(n))}catch(e){}}else setTimeout(function(){twosevenExtLog("utils-bg","Retrying: "+t+": "+JSON.stringify(n)),assuredSend(e,t,n)},1e3)}function isRequestOnTwoSeven(e){if(e.initiator&&isOnTwoSeven(e.initiator))return!0;const t=getHeaderValue("referer",e.requestHeaders);return!(!t||!isOnTwoSeven(t))||void 0}window.is=window.twoseven.is;class PrioritizedCallbacks{constructor(e){this.name=e,this.listenersMap={};const t=PrioritizedCallbacks.Levels;Object.values(t).forEach(e=>{this.listenersMap[e]=new Set},this)}static get Levels(){return{DEFAULT:0,LAST:-1,FIRST:1,ALWAYS_FIRST:2,ALWAYS_LAST:-2}}addListener(e,t=PrioritizedCallbacks.Levels.DEFAULT){this.listenersMap[t].add(e)}removeListener(e,t){if(t)return this.listenersMap[t].delete(e);Object.entries(this.listenersMap).forEach(([t,n])=>{n.delete(e)})}get listeners(){const e=[],t=Object.values(PrioritizedCallbacks.Levels);return t.sort((e,t)=>t-e),t.map(t=>e.push(...Array.from(this.listenersMap[t])),this),e}}function createWindow(e,t){return new Promise(n=>{const r=window.screen.height/12|0,s=window.screen.width/12|0,o=deepmerge({url:e,type:"popup",width:6*s,height:6*r,left:3*s,top:3*r},t||{});browser.windows.create(o,n)})}function toast(e,t){if(!twosevenTabs[t])return void console.error("Cannot toast on a non-twoseven tab");const n={data:{action:"generic-toast",...e}};browser.tabs.executeScript(t,{code:`triggerEvent(window, 'ext-event', JSON.stringify(${JSON.stringify(n)}), true)`})}function getExtensionID(){return browser.i18n.getMessage("@@extension_id")}function evaluateOnPageAndGetResponse(e,t,n,r,s=500){r=r||[];const o=uuid(),i=new Deferred,a=setTimeout(()=>i.resolve(null),s);browser.runtime.onMessage.addListener(function e(t,n){const{action:r}=t;if(r!==o)return;const{data:s}=t;browser.runtime.onMessage.removeListener(e),clearTimeout(a),i.resolve(s)});let c=e.toString();for(const e of r){const{pattern:t,replacement:n}=e;let r;r=t instanceof RegExp?t:new RegExp(t,"g"),c=c.replace(r,n)}const u=`\n  ;(async () => {\n      const result = await (${c.toString().replace(/`/g,"\\`")})();\n      if (result) {\n        triggerEvent(window, 'ts:relay-bg', { realAction: '${o}', data: result }, true)\n      }\n  })()`;return browser.tabs.executeScript(t,{frameId:n,code:`injectScript(\`${u.toString()}\`)`}),i}browser.runtime.onMessage.addListener((e,t)=>{if("toast-cb"!==e.action)return;const{tab:{id:n},frameId:r}=t,{delay:s,callbackAction:o}=e;let{msg:i}=e;const a=`toast-cb-${uuid()}`,c=`toast-id-${uuid()}`;i=i.replace("{{id}}",c).replace(new RegExp("{{onclick}}"),`triggerEvent(window, 'ts:relay-bg', JSON.stringify({ realAction: '${a}' }), true); window.M.Toast.getInstance(document.querySelector('#${c}').closest('.toast')).dismiss()`),browser.runtime.onMessage.addListener(function e(t){t.action===a&&(browser.runtime.onMessage.removeListener(e),browser.tabs.executeScript(n,{frameId:r,code:`window.twoseven.postTo(window, { action: '${o}' })`}))}),toast({msg:i,delay:s},n)}),window.getExtensionID=getExtensionID,window.evaluateOnPageAndGetResponse=evaluateOnPageAndGetResponse;