const websites=[new RegExp("https://([a-z]+\\.)?netflix\\.com/.*"),new RegExp("https://([a-z]+\\.)?amazon\\.([a-z.])+/.*"),new RegExp("https://([a-z]+\\.)?hulu\\.com/.*"),new RegExp("https://([a-z]+\\.)?disneyplus\\.com/.*")],cacheBusterMap=new Map;async function bustCache(e,t){const a=new Deferred;return browser.tabs.create({url:"about:blank",active:!1},t=>{const{id:s}=t;let o=!1;browser.webNavigation.onCompleted.addListener(function t({tabId:r,frameId:n,url:i}){if(r===s&&i===e){if(o)return browser.webNavigation.onCompleted.removeListener(t),browser.tabs.remove(r),a.resolve();o=!0,browser.tabs.reload(r,{bypassCache:!0})}}),browser.tabs.update(s,{url:e})}),await a,browser.tabs.update(t,{active:!0}),window.test&&localStorage.setItem("no-block",1),new Promise(e=>browser.tabs.reload(t,{bypassCache:!0},()=>e()))}{const e="[cache-buster]";for(const e of websites)cacheBusterMap.set(e,0);browser.webNavigation.onCommitted.addListener(({tabId:t,frameId:a,url:s})=>{if(0!==a||isPausedOnWebsite(s))return;const o=Date.now();for(const a of websites){const r=cacheBusterMap.get(a);if(a.test(s))return void(o-r>6e5&&(cacheBusterMap.set(a,o),twosevenExtLog(e,`Bypassing cache on website: ${a}`,"info"),browser.tabs.reload(t,{bypassCache:!0})))}}),browser.runtime.onMessage.addListener(async e=>{try{if("bust-cache"!==e.action)return;const{data:{url:t,tabId:a}}=e,s=new URI(t).domain();toast({msg:`${s} will open in a new tab and reload. Then, this page will reload...`},a),await new Promise(e=>setTimeout(e,3e3)),bustCache(t,a)}catch(e){}})}