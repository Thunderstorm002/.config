const RUN_ONLY_IN_IFRAMES=!0;class ScriptModifierMap{constructor(e=[],t){e.forEach(e=>this.addEntry(e)),Object.defineProperty(this,"event",{enumerable:!1,value:t})}addEntry({key:e,value:t}){Object.assign(this,{[md5(e)]:{key:e,value:t}})}}class ScriptModifierEntry{constructor({replace:e,position:t,event:o}){this.replace=e,this.position=t,this.event=o,t&&(this.startPosition=t-1e3,this.endPosition=t+1e3)}}async function pullScriptAndModify(e,t,o,r){let i;if(e)try{const t=await fetch(e);i=await t.text()}catch(e){throw twosevenExtLog(o,"Error encountered while attempting to XHR script: "+e),e}else i=r;return modifyScript(i,t,o,e)}async function modifyScript(e,t,o,r){let i=e;if(t.event)try{triggerEvent(window,t.event)}catch(e){}for(var n of Object.values(t)){const{key:t,value:s}=n;let c;if("string"!=typeof s){const{startPosition:e=0,endPosition:n=i.length,replace:d}=s,a=i.substring(e,n);if(t instanceof XRegExp&&(c=XRegExp.exec(a,t)),"string"==typeof t&&-1===a.indexOf(t)||t instanceof XRegExp&&!c){const e=`'DID NOT FIND: ${t}`;twosevenExtLog(o,e);try{window.twoseven.reportError(o,new Error(e),{url:r,key:t.toString(),value:s})}catch(e){}}else{let r;twosevenExtLog(o,"Replacing: "+t+"  --\x3e  "+s),r=c?XRegExp.replace(a,t,d):a.replace(t,d),i=i.substring(0,e)+r+i.substring(n,i.length)}}else if(-1===e.indexOf(t)){const e=`DID NOT FIND: ${t}`;twosevenExtLog(o,e);try{window.twoseven.reportError(o,new Error(e),{key:t,value:s})}catch(e){}}else twosevenExtLog(o,"Replacing: "+t+"  --\x3e  "+s),i=i.replace(t,s)}return i}function addModifiedScript(e,t,o=!1,r={}){r||(r={});var i=document.createElement("script");i.type="text/javascript",i.dataset.addedByTwoSeven="1",e&&(i.id="__modifiedScript",i.text=e),t&&(i.defer=t.defer,i.async=t.async,i.dataset.origSrc=t.src),o&&(i.src=t.src);const{beforeAdd:n,afterAdd:s}=r;return n&&n(i),(document.head||document.body).appendChild(i),s&&s(i),i}(()=>{window.setupScriptModifier=function(e,t,o,r="head",i,n={}){const s=`${e}-script-modifier`;if(RUN_ONLY_IN_IFRAMES&&window.top===window)return void twosevenExtLog(s,"Skipping scriptModifier in top window");i=i||{};const{reloadAllScripts:c=!1,checkAllScripts:d=!1}=i;r=r.toUpperCase(),twosevenExtLog(s,"Running...");const a=new Set;function l(e,t,o=!1){addModifiedScript(e,t,o,{beforeAdd(e){a.add(e),twosevenExtLog(s,"Successfully modified script")},afterAdd(e){n.onModify&&n.onModify(e)}})}function f(e){let o=!1;try{o=t(e)}catch(e){}return o}async function p(e){const t=f(e);if(c&&!t)return e.src?l(null,e,!0):l(e.text,e);if(t){let t=null;t="LINK"===e.tagName?e.href+"?allow=true":e.src?e.src+"?allow=true":null,twosevenExtLog(s,"script: "+t),l(await pullScriptAndModify(t,o,s,e.text),e)}}async function u(e){for(var t of e)await p(t),a.add(t)}const y=new Set;function w(e){const t=[];for(var o=0;o<e.length;o++){var r=e[o];if(!y.has(r)&&(f(r)||c)){if(y.add(r),a.has(r)||"1"===r.dataset.addedByTwoSeven)continue;t.push(r);try{r.parentNode.removeChild(r)}catch(e){}twosevenExtLog(s,"Removed original script tag")}}return t}let v;const g=new MutationObserver(e=>{for(const t of e)if("childList"===t.type){const e=Array.from(t.addedNodes),o=e.filter(e=>"SCRIPT"===e.tagName),r=e.filter(e=>"LINK"===e.tagName&&"script"===e.as.toLowerCase());o.push(...r),o.length>0&&(d&&o.push(...Array.from(v.querySelectorAll("script"))),u(w(o)))}}),h=new MutationObserver(e=>{for(const t of e)if("childList"===t.type){const e=Array.from(t.addedNodes);if("DOCUMENT"!==r){const t=e.find(e=>e.tagName===r);t&&(v=t,h.disconnect(),twosevenExtLog(s,`Initialized <${r}> MutationObserver`),g.observe(t,{childList:!0}),u(v.getElementsByTagName("script")),n.onObserveNode&&n.onObserveNode(v))}else{const t=e.filter(e=>"SCRIPT"===e.tagName);t.length>0&&u(w(t))}}});h.observe(document,{childList:!0,subtree:!0})},window.twoseven.pullScriptAndModify=pullScriptAndModify})();try{module&&(module.exports={ScriptModifierMap:ScriptModifierMap,ScriptModifierEntry:ScriptModifierEntry,pullScriptAndModify:pullScriptAndModify})}catch(e){}