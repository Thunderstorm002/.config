window.twoseven.getModule=(async(e=window.location.href)=>{const n=await window.getMatchingWebpageIframeModule(e),t=await window.getMatchingGenericFallbackModule(e);return n||t}),(async()=>{if(window.top===window)return;let e="webpage-iframe";window.name.endsWith("-iframe")&&(e=window.name);const n=e;twosevenExtLog(n,`Moved to href=${window.location.href}`),window.addEventListener("message",async e=>{const{data:n={}}=e;try{const{action:t}=n;if("get-parent-url"!==t)return;if(window.parent!==window.top){const{href:n}=await postToParent({action:t},!0);postResponse(e,{href:n,parent:window.location.href})}postResponse(e,{href:window.location.href,parent:window.location.href})}catch(e){}}),window.twoseven.isOnTwoSeven=(()=>new Promise(n=>{const t=browser.runtime.connect({name:e});t.onMessage.addListener(e=>{const{action:t,value:o=!1}=e;"is-on-twoseven"===t&&n(o)}),t.postMessage({action:"is-on-twoseven"})}));const t=await window.twoseven.getModule();if(t&&t.earlyInitialize(),window.mod=t,t){await window.twoseven.isOnTwoSeven()?(twosevenExtLog(n,`Initializing since we're on twoseven..module=${t.name}`),async function(){if(injectStylesheetByURL(browser.extension.getURL("js/webpage-iframe/fullscreen.css")),injectScriptByURL(browser.extension.getURL("node_modules/plyr/dist/plyr.js")),injectStylesheetByURL(browser.extension.getURL("node_modules/plyr/dist/plyr.css")),!t)return;twosevenExtLog(n,`Initializing module=${t.name}`),t.initialize(),await waitForDOMNode({type:"tag",value:"body"}),twosevenExtLog(n,"<body> available. Observing for <video> tags"),t.useBodyObserver()&&function(e){const n=Array.from(document.querySelectorAll("video")),t=Array.from(document.querySelectorAll("audio"));a(n),a(t);const o=new MutationObserver(e=>{for(const n of e){const e=n.addedNodes;if(e.length>0){const e=Array.from(document.querySelectorAll("video")),n=Array.from(document.querySelectorAll("audio"));a(e),a(n)}}});o.observe(e,{childList:!0,subtree:!0}),window.onunload=o.disconnect}(document);t.on("controller-ready",async(o={})=>{o.videoURL||(o.videoURL=window.location.href);const{videoURL:r,videoData:i={}}=o;twosevenExtLog(n,"Processing controller-ready event");const a=await postToParent({action:"mediaEntry",name:e,videoSelector:t.videoSelector()},!0);let s=await t.getActions();if("function"==typeof s&&(s=await s()),t.doVideoURLsMatch(o,a))t.on("controller-initialized",async function o(){t.off("controller-initialized",o);const r=await t.getMediaElement(),i=new Deferred;if(r){r.readyState>=2&&i.resolve();const e=()=>{r.removeEventListener("loadeddata",e),r.removeEventListener("timeupdate",e),i.resolve()};r.addEventListener("loadeddata",e),r.addEventListener("timeupdate",e)}else i.resolve();await i;let s=await t.getActions();"function"==typeof s&&(s=await s());let c=a.position||0;const{status:d}=a;if("playing"===d&&a.lastPlayTimestampMS>0&&(c+=moment.utc().valueOf()-a.lastPlayTimestampMS+300),0!==c){window.twoseven.convertToVideoTime(c);await s.seek({position:c}),"playing"===a.status?await s.play():await s.pause()}twosevenExtLog(n,"Module's controller has been initialized"),postToParent({action:"video-ready",name:e,json:{videoSelector:a.videoSelector}}),t.initialized=!0}),t.emit("same-url",a);else{const n=1e3*await s.currentTime(),o="paused",a={videoSelector:t.videoSelector(),videoURL:r,videoData:{...i,extensionSettings:{module:"videoshare-watch-iframe"}},from:`js/videoshare-watch-iframe.js[${t.name}]`,referer:r,origin:new URL(r).origin,strategies:null,headers:[],position:n,status:o};await postToParent({action:"sourceChange",name:e,json:a})}}),initializeDRMHandler(n,t.getActions())}()):twosevenExtLog(n,"Not initializing since we're not on twoseven")}window.twoseven.triggerJS=((e,n)=>{triggerEvent(e,n,{fromJS:!0})}),window.twoseven.initializeGenericIframeActions=(()=>{function e(){return t.getVideo()||document.body.querySelector("video")}return{async play(){e().play(!0)},async pause(){e().pause(!0)},async seek({position:n}){const t=e();Math.abs(n-1e3*t.currentTime)<100||t.seek(n,!0)},sourceChange(){},currentTime:async()=>e().currentTime,duration:async()=>e().duration,playerStatus:async()=>e().paused?"paused":"playing",source:async()=>e().src||e().srcObject,interactiveChoice(){}}}),window.twoseven.initializePlyrActions=(e=>{return{async play(){injectScript("window.plyr.media.play()",!0)},async pause(){injectScript("window.plyr.media.pause()",!0)},async seek({position:n}){Math.abs(n-1e3*e().currentTime)<100||injectScript(`window.plyr.media.currentTime = ${n} / 1e3`,!0)},sourceChange(){},currentTime:async()=>e().currentTime,duration:async()=>e().duration,playerStatus:async()=>e().paused?"paused":"playing",async source(){const n=e();return n.src||n.srcObject},interactiveChoice(){}}}),window.twoseven.initializeIntermediateIframeActions=(n=>{const t={async play(){const t=n();postTo(t,{action:"play",name:e})},async pause(){const t=n();postTo(t,{action:"pause",name:e})},async seek({position:o}){const r=await t.currentTime();if(Math.abs(o-1e3*r)<100)return;const i=n();postTo(i,{action:"seek",name:e,position:o})},sourceChange(){},async currentTime(){const t=n();return(await postTo(t,{action:"currentTime",name:e},!0)).result},async duration(){const t=n();return(await postTo(t,{action:"duration",name:e},!0)).result},async playerStatus(){const t=n();return(await postTo(t,{action:"playerStatus",name:e},!0)).result},async source(){const e=n();return(await postTo(e,{action:"source"},!0)).result},interactiveChoice(){}};return t}),window.twoseven.fullscreenHandlers={toggleFullscreen(){postToParent({action:"fullscreen",name:e})},handleKeys(e){switch(e.stopImmediatePropagation(),e.preventDefault(),e.ctrlKey||e.shiftKey||e.altKey,e.which){case 70:window.twoseven.fullscreenHandlers.toggleFullscreen()}return!1},safeHandleKeys(e){"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&window.twoseven.fullscreenHandlers.handleKeys(e)}};const o=[],r=[];function i(r){!function(o){window.removeEventListener("keyup",window.twoseven.fullscreenHandlers.safeHandleKeys),window.addEventListener("keyup",window.twoseven.fullscreenHandlers.safeHandleKeys),o.removeEventListener("keyup",window.twoseven.fullscreenHandlers.safeHandleKeys),o.addEventListener("keyup",window.twoseven.fullscreenHandlers.safeHandleKeys);const r=new Emittery;r.video=o,Object.assign(r,{play(n){n?r.video.play():postToParent({action:"play",name:e,json:{position:1e3*o.currentTime}})},pause(n){n?r.video.pause():postToParent({action:"pause",name:e,json:{position:1e3*r.video.currentTime}})},seek(n,t){const o=n/1e3;t?Math.abs(r.video.currentTime-o)>.1&&(r.video.currentTime=o):postToParent({action:"seek",name:e,json:{position:n}})},playerStatus:()=>r.video.paused?"paused":"playing",sourceChange(){twosevenExtLog(n,"WARNING: sourceChange unimplemented")},source:()=>o.src||o.srcObject,interactiveChoice(){twosevenExtLog(n,"WARNING: interactiveChoice unimplemented")}}),["currentTime","duration","paused"].forEach(e=>{Object.defineProperty(r,e,{get:function(){return r.video[e]},configurable:!0})}),t.onVideo&&t.onVideo(r,o)}(r),o.push(r)}function a(e){(e=e.filter(e=>!r.includes(e))).forEach(e=>r.push(e)),e.length>0&&twosevenExtLog(n,`Checking ${e.length} videos`),(e=e.filter(t.isValidVideoElement.bind(t))).length>0&&window.tsdebug,e.forEach(e=>o.push(e)),e.forEach(i)}window.twoseven.processedVideos=r,window.twoseven.registeredVideos=o,t&&t.on("process-video-elements",a),window.twoseven.wrapWithPlyr=function(e,t,o=window.parent,r={}){const{restorePlayStateOnSeek:i=!1}=r,a=new Deferred,{body:s}=document;if(e.parentInfo){const{parentInfo:{plyrParent:n,videoContainer:t,plyrSelfIndex:o}}=e;return t.classList.add("twoseven-fullscreen"),void n.insertBefore(e,n.children[o])}const{parentNode:c}=e,d=[...e.parentNode.children].indexOf(e);let l=document.querySelector(".twoseven-fullscreen");l||((l=document.createElement("div")).classList.add("twoseven-fullscreen"),l.appendChild(e),s.prepend(l)),l.classList.remove("twoseven-hidden"),s.classList.add("twoseven-wrapped"),s.parentNode.classList.add("twoseven-wrapped");const w=()=>{e.parentInfo={videoContainer:l,originalParent:c,originalSelfIndex:d},a.resolve()};window.removeEventListener("plyr-wrapper-ready",w),window.addEventListener("plyr-wrapper-ready",w),injectScript(`\n      ;(async () => {\n        const video = document.querySelector('.twoseven-fullscreen video')\n\n        async function addTracks (tracks) {\n          for (let trackEntry of tracks) {\n            const { src: origSrc, kind, label, srclang } = trackEntry\n            const children = [...video.children]\n            const trackAlreadyAdded = children.find(el => el.dataset.src === origSrc)\n            if (trackAlreadyAdded) {\n              continue\n            }\n            const track = document.createElement('track')\n            let src = origSrc\n\n            const response = await fetch(src)\n            let text = await response.text()\n            src = URL.createObjectURL(new Blob([text], {\n              type: 'text/vtt'\n            }))\n            track.dataset.src = origSrc\n\n            track.src = src\n            track.kind = kind\n            track.label = label\n            track.srclang = srclang\n            video.appendChild(track)\n          }\n        }\n\n        if (${!!t.videoData.textTracks}) {\n          const tracks = ${JSON.stringify(t.videoData.textTracks)}\n          window.tracks = tracks\n          window.addTracks = addTracks\n          await addTracks(tracks)\n          // For some reason, at least vlive.tv does not add all tracks correctly the first time\n          await addTracks(tracks)\n        } else {\n        }\n        const plyr = new Plyr(video, {\n          autoplay: false,\n          captions: {\n            active: true,\n            language: 'auto',\n            update: true\n          },\n          settings: [\n            'captions',\n            'quality',\n            'speed',\n            'loop'\n          ],\n          keyboard: {\n            focused: true,\n            global: true\n          },\n          listeners: {\n            play (e) {\n              if (plyr.playing) {\n                triggerEvent(window, 'user-clicked-pause')\n              } else {\n                triggerEvent(window, 'user-clicked-play')\n              }\n            },\n            seek (e) {\n              try {\n                const position = ((e.target.value / e.target.max) * (plyr.duration)) * 1e3\n                triggerEvent(window, 'user-seeked', {position, playing: plyr.playing})\n              } catch (e) {\n                twoseven.reportError(e, 'plyr failed to seek')\n                console.error(e)\n              }\n            },\n            fastForward (e) {\n              try {\n                const position = (this.currentTime + this.config.seekTime) * 1e3\n                triggerEvent(window, 'user-seeked', {position, playing: plyr.playing})\n              } catch (e) {\n                twoseven.reportError(e, 'plyr failed to seek')\n                console.error(e)\n              }\n            },\n            rewind (e) {\n              try {\n                const position = (this.currentTime - this.config.seekTime) * 1e3\n                triggerEvent(window, 'user-seeked', {position, playing: plyr.playing})\n              } catch (e) {\n                twoseven.reportError('${n}', e, 'plyr failed to seek')\n                console.error(e)\n              }\n            },\n            fullscreen (e) {\n              e.preventDefault()\n              triggerEvent(window, 'user-toggled-fullscreen')\n            }\n          }\n        })\n        window.plyr = plyr\n        plyr.on('ready', () => {\n          triggerEvent(window, 'plyr-wrapper-ready')\n        })\n      })()\n    `);const p="webpage-iframe:inner",u=()=>{postTo(o,{action:"play",from:"plyr-action",name:p,json:{position:1e3*e.currentTime}})},y=()=>{postTo(o,{action:"pause",from:"plyr-action",name:p,json:{position:1e3*e.currentTime}})},v=n=>{const{detail:{data:{position:t,playing:r}}}=n;i&&once(e,"seeked",()=>{once(e,"canplay",()=>{setTimeout(()=>{r?e.play():e.pause()},300)})}),postTo(o,{action:"seek",from:"plyr-action",name:p,json:{position:t}})},m=()=>{postTo(o,{action:"fullscreen",from:"plyr-action",name:p})};return window.removeEventListener("user-clicked-play",u),window.addEventListener("user-clicked-play",u),window.removeEventListener("user-clicked-pause",y),window.addEventListener("user-clicked-pause",y),window.removeEventListener("user-seeked",v),window.addEventListener("user-seeked",v),window.removeEventListener("user-toggled-fullscreen",m),window.addEventListener("user-toggled-fullscreen",m),a},window.twoseven.revertPlyr=function(e){const{parentInfo:{originalParent:n,originalSelfIndex:t,videoContainer:o}}=e,{parentNode:r}=e;o.classList.add("twoseven-hidden");const i=[...e.parentNode.children].indexOf(e);Object.assign(e.parentInfo,{plyrParent:r,plyrSelfIndex:i}),n.insertBefore(e,n.children[t]);const{body:a}=document;a.classList.remove("twoseven-wrapped"),a.parentNode.classList.remove("twoseven-wrapped")}})();