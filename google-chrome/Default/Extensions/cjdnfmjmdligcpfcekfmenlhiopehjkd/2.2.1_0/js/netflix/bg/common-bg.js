(()=>{browser.runtime.onConnect.addListener(e=>{"netflix-media-finder"===e.name&&e.onMessage.addListener(async t=>{const s=getTabIdFromPort(e),{frameId:i}=e.sender;switch(t.action){case"found-media":{const{data:a}=t;a.listeners={afterTriggerWatch(t){e.postMessage({action:"triggered-watch-pause"})}},addTabMedia(s,i,a);break}}})});const e="Add 'netflix.com' to the SameSite domains on the <a class=\"toast-close\" onclick=\"triggerEvent(window, 'ext-open-settings')\">extension settings page</a> and then reload this page.",t=window.twoseven.throttle((e,t)=>{toast(e,t)},1e4);function s(e,s){t({msg:`Click <a class="toast-close" onclick="triggerEvent(window, 'ext-navigate', { tabId: ${e}, frameId: ${s}, location: 'https://www.netflix.com/clearcookies', newTab: true })">here</a> to Login and select profile. Then, refresh this page.`,delay:15e3},e)}browser.webRequest.onHeadersReceived.addListener(i=>{const{tabId:a,frameId:o,statusCode:n}=i,r=settings[SETTINGS.general.sameSiteDomains].includes(".netflix.com");i.url.includes("Login")?r?s(a,o):t({msg:`Either you or someone in the room is loading Netflix. This website is known to require SameSite modifications. ${e}`,delay:6e4},a):(i.url.includes("logout")&&s(a,o),i.url.match("https://www.netflix.com/api/shakti/.*/profiles/switch.*")&&500===n&&(r?s(a,o):t({msg:`It looks like this website needs SameSite cookie modifications. ${e}`,delay:6e4},a)))},{urls:["https://www.netflix.com/*"]}),browser.webRequest.onBeforeRequest.addListener(async e=>{const{tabId:t,frameId:s,url:i,type:a}=e,o=new URI(i),n=o.search(!0),{"ts-bypass":r}=n;if("sub_frame"!==a||!twosevenTabs[t]||"true"===r)return;o.addSearch({"ts-bypass":!0});const d=o.toString(),c=await axios.get(d),{request:{responseURL:l}}=c;l!==d&&browser.tabs.executeScript(t,{frameId:s,code:`location.href = '${l}'`})},{urls:["https://www.netflix.com/title/*","https://www.netflix.ca/title/*"]})})();