!function(){const e="netflix";if(window.top===window)return void twosevenExtLog("Skipping extension logic");if(window.twoseven.is.chrome()){const t="ts-netflix-reload";if(!sessionStorage.getItem(t))return sessionStorage.setItem(t,1),void(async()=>{await sendMessageToBG("clear-cache",{url:window.location.href,origins:[window.location.origin]}),twosevenExtLog(e,"Reloading once after clearing cache"),window.location.reload()})()}async function t(e){const{result:t}=await postTo(window,{action:"player-cmd",drmIgnore:!0,cmd:e},!0);return t}function n(e,t=!1){let n=[...e.classList].find(e=>e.startsWith("button-nfplayer")).replace(/button-nfplayer/,"").toLowerCase();return t&&(n="play"===n?"pause":"play"),n}injectScript("\n    twoseven.netflixVideoController = {\n      play () {\n        if (twoseven.netflixVideoController.controller) {\n          return this.controller.play()\n        } else {\n          getPlayer().play()\n        }\n      },\n      pause () {\n        if (twoseven.netflixVideoController.controller) {\n          return this.controller.pause()\n        } else {\n          getPlayer().pause()\n        }\n      },\n      seek (pos) { // pos should be in milliseconds\n        if (false) {\n          pos /= 1e3\n        }\n        if (twoseven.netflixVideoController.controller) {\n          return this.controller.seek(pos)\n        } else {\n          getPlayer().seek(pos)\n        }\n      }\n    }\n\n    twoseven.setGlobalNetflixController = (controller) => {\n      twoseven.netflixVideoController.controller = twoseven.netflixVideoController.controller || controller\n    }\n\n    window.addEventListener('message', ({ data = {} }) => {\n      if (data.action !== 'player-cmd') {\n        return\n      }\n      const { cmd, ack } = data\n      let result\n      switch (cmd) {\n        case 'currentTime':\n          result = window.getPlayer().getCurrentTime()\n          break\n      }\n      if (ack) {\n        window.postMessage({\n          action: ack.event,\n          drmIgnore: true,\n          json: { result }\n        }, '*')\n      }\n    })\n  "),window.runPlayerCommand=t;const o=function(){function o(){return document.getElementsByTagName("video")[0]}function i(){return window.location.origin+window.location.pathname}window.getVideo=o;const a={play(){injectScript("twoseven.netflixVideoController.play()",!0)},pause(){injectScript("twoseven.netflixVideoController.pause()",!0)},async seek({position:e}){const n=await t("currentTime");Math.abs(e-n)<100||injectScript(`\n          twoseven.netflixVideoController.seek(${e})\n        `,!0)},sourceChange(e){const t=e.newMedia;if(i()===t.videoURL||window.location.href.startsWith(t.videoURL)){let e=t.position;t.lastPlayTimestampMS>0&&(e+=Date.now()-t.lastPlayTimestampMS),"playing"===t.status?(this.seek({position:e}),this.play()):this.pause(),postToParent({action:"video-controller-ready",name:name,json:{videoSelector:"netflix"}})}else window.location.href=t.videoURL},currentTime:()=>t("currentTime"),duration:()=>o().duration,source:()=>i(),interactiveChoice(e){const{videoData:{interactiveChoice:{label:t,segmentID:n}}}=e;if(!t&&!n)return console.error("Cannot make a choice when neither label nor segmentID is available");const o=document.querySelector(".nf-player-container"),i=o.querySelector(`[aria-label="${t}"]`)||o.querySelector(`[data-segment-id="${n}"]`);if(!i)return console.error(`Could not find the choice to select. label=${t} segmentID=${n}`);i.dataset.broadcast=!1,window.twoseven.triggerMouseEvent("mouseup",i)}};let r,s,c;return injectScript("\n      var c = console.log\n      console.log = function(args) {\n        c('netflix-iframe: ' + args)\n      }\n    "),setInterval(async()=>{const l=document.querySelector(".nf-big-play-pause button");l&&"true"!==l.getAttribute("aria-hidden")&&(window.twoseven.triggerMouseEvent("click",l),injectScript("document.querySelector('.nf-big-play-pause button').click(); twosevenExtLog('netflix', 'Clicked big button')",!0));var d=getPlayPauseButton();const u=i();let p=!1;if(d){if(r!==d||c!==u){p=!0,c=u,twosevenExtLog(e,"Found new play/pause button"),r=d,s&&clearInterval(s),s=setInterval(()=>{const e=document.querySelector(".nf-player-container");e&&e.querySelectorAll(".BranchingInteractiveScene--choice-selection").forEach(e=>{e.addEventListener("click",e=>{e.stopImmediatePropagation(),e.preventDefault();const{target:t}=e,n=t.closest(".BranchingInteractiveScene--choice-selection"),o=n.attributes["aria-label"]&&n.attributes["aria-label"].nodeValue,a=n.dataset.segmentId;return"false"!==n.dataset.broadcast?(postToParent({action:"interactiveChoice",name:name,json:{videoURL:i(),videoData:{interactiveChoice:{label:o,segmentID:a}}}}),!1):(console.log(`Registered a click on label=${o} segmentID=${a}`),void delete n.dataset.broadcast)})})},50),injectScript("\n          delete twoseven.netflixVideoController.controller\n          window.getPlayer = function () {\n            let videoPlayer = netflix.appContext.state.playerApp.getAPI().videoPlayer\n            // Getting player id\n            let playerSessionId = videoPlayer.getAllPlayerSessionIds()[0]\n            let player = videoPlayer.getVideoPlayerBySessionId(playerSessionId)\n            twoseven.setGlobalNetflixController(player)\n            return player\n          }\n\n        ");const l=await getMetadata(i());p&&postToParent({action:"sourceChange",name:name,json:{videoURL:i(),videoData:l,position:await t("currentTime")}});const w=window.getVideo(),f=document.querySelector(".scrubber-bar");if(f){let e=!1;const t=t=>{e=!0},n=t=>{if(!e)return;const n=f.querySelector(".scrubber-head"),o=Number(n.getAttribute("aria-valuenow"));postToParent({action:"pause",name:name,json:{position:1e3*o}}),e=!1};f.removeEventListener("mousedown",t),f.addEventListener("mousedown",t),window.removeEventListener("mouseup",n),window.addEventListener("mouseup",n)}async function m(e,n){switch(n||(n=w.paused?"pause":"play"),n){case"play":injectScript("twoseven.netflixVideoController.pause()",!0);break;case"pause":injectScript("twoseven.netflixVideoController.play()",!0)}postToParent({action:n,name:name,json:{position:await t("currentTime")}})}r.addEventListener("click",function e(t){r.removeEventListener("click",e),o().pause()});const y=o().paused;window.twoseven.triggerMouseEvent("click",r);const g=t=>{const{detail:o={}}=t,{data:i={}}=o,{sync:a=!0}=i;if(a){const o=n(t.target);twosevenExtLog(e,`posting action=${o} to parent`),m(0,o)}};r.removeEventListener("click",g),r.addEventListener("click",g);const k=document.querySelector(".center-controls"),b=t=>{t.stopImmediatePropagation(),t.preventDefault();const o=n(getPlayPauseButton());return twosevenExtLog(e,`posting action=${o} to parent`),m(0,o),!1};k.removeEventListener("click",b),k.addEventListener("click",b);const h=document.querySelector(".button-nfplayerFullscreen");if(h){const e=e=>(e.stopImmediatePropagation(),e.preventDefault(),postToParent({action:"fullscreen",name:name}),!1);h.removeEventListener("click",e),h.addEventListener("click",e)}const L=document.querySelector(".button-nfplayerFastForward"),E=async e=>(e.stopImmediatePropagation(),e.preventDefault(),postToParent({action:"seek",name:name,json:{position:await t("currentTime")}}),!1);L.removeEventListener("click",E),L.addEventListener("click",E);const P=document.querySelector(".button-nfplayerBackTen");if(P){const e=async e=>(e.stopImmediatePropagation(),e.preventDefault(),postToParent({action:"seek",name:name,json:{position:await t("currentTime")}}),!1);P.removeEventListener("click",e),P.addEventListener("click",e)}const S=e=>{const n=o();n.addEventListener("seeked",async function e(){n.removeEventListener("seeked",e),postToParent({action:"seek",name:name,json:{position:await t("currentTime")}})})};new MutationObserver(async e=>{for(const t of e)if("childList"===t.type){const e=Array.from(t.addedNodes).find(e=>e.classList&&e.classList.contains("skip-credits"));if(!e)return;const n=[...e.children].find(e=>"A"===e.tagName);n&&(n.removeEventListener("click",S),n.addEventListener("click",S))}}).observe(document.body,{childList:!0,subtree:!0});const x=document.querySelector(".skip-credits > a");async function v(o){switch(o.stopImmediatePropagation(),o.preventDefault(),o.ctrlKey||o.shiftKey||o.altKey,o.which){case 32:{const t=n(getPlayPauseButton(),!0);twosevenExtLog(e,`posting action=${t} to parent`),m(0,t);break}case 37:case 39:postToParent({action:"seek",name:name,json:{position:await t("currentTime")}});break;case 70:return postToParent({action:"fullscreen",name:name})}return!1}x&&(x.removeEventListener("click",S),x.addEventListener("click",S));const T=document.querySelector(".nf-player-container");if(T.removeEventListener("keyup",v),T.addEventListener("keyup",v),p){const e=await postToParent({action:"mediaEntry",videoSelector:"netflix"},!0);a.sourceChange({newMedia:e})}else y?w.pause():w.play()}}else c=c!==u?void 0:c},100),a}();initializeDRMHandler(name,o)}();