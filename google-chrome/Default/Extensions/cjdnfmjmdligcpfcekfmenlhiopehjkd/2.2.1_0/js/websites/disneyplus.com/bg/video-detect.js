(()=>{const e={};let t;const s={},n=["watch-iframe[disneyplus.com]","[disney+:media-detector]"];function d(e,{origin:t,url:s,tabId:n,videoURL:d=tabURLs[n]}){let i,r,o,c={};if(e){if(s.includes("DmcSeries"))try{const{data:{data:{DmcSeriesBundle:{episodes:{videos:[t]}}}}}=e;c=t}catch(e){console.error(e)}else if(s.includes("DmcVideoBundle")){const{data:{data:{DmcVideoBundle:{video:t}}}}=e;c=t}else{const{data:{data:{DmcVideo:{video:t}}}}=e;c=t}const{images:t,texts:n}=c;i=(t.find(e=>1.78===e.aspectRatio)||t[0]).url;const d=n.filter(e=>"title"===e.field&&"full"===e.type),a=r=(d.find(e=>"program"===e.sourceEntity)||d[0]).content,{episodeNumber:l,episodeSequenceNumber:u,seasonSequenceNumber:m}=c,p=l||u,g=m;try{o=(d.find(e=>"series"===e.sourceEntity)||d[0]).content}catch(e){}const{videoId:I,encodedVideoId:v,contentId:D,encodedContentId:b,genres:f}=c;c={videoID:I,encodedVideoID:v,contentID:D,encodedContentID:b,title:r,poster:i,genres:f,showTitle:o,episodeTitle:a,episodeIndex:p,seasonIndex:g}}return{videoSelector:"disneyplus",videoURL:d,videoData:{poster:i,title:r,isLocked:{reason:"privilege",value:"VIDEO_SELECTOR_DISNEY+",until:1669888e6},origin:t,referer:d,...c},origin:t,referer:d,strategies:null,headers:[]}}browser.runtime.onConnect.addListener(e=>{if(!n.includes(e.name))return;const t=getTabIdFromPort(e);e.onMessage.addListener(async n=>{const{action:i}=n;switch(i){case"get-media-entry":{let i,r=!0;const{url:o}=n,c=function(e){let t;return t=s.video?s.video.replace(/contentId\/.*/,`contentId/${e}`):s.series?s.series.replace(/DmcSeriesBundle/,"DmcVideo").replace(/encodedSeriesId\/.*/,`contentId/${e}`):s.video.replace(/DmcVideoBundle/,"DmcVideo").replace(/contentId\/.*/,`contentId/${e}`)}(o.replace(/https:\/\/www.disneyplus.com\/(.*\/)?video\//,""));if(c){const e=new URI(c),s=e.search(!0);Object.assign(s,{"ts-bypass":!0}),e.search(s);const n=e.toString();for(let e=0;e<3;e++)try{i=d(await axios.get(n),{origin:new URL(o).origin,url:n,tabId:t,videoURL:o}),r=!1;break}catch(e){}}r&&(i=d(null,{origin:new URL(o).origin,url:null,tabId:t,videoURL:o})),e.postMessage({action:"get-media-entry",data:i});break}}})}),browser.webRequest.onBeforeSendHeaders.addListener(n=>{let d;return n.url.includes("DmcVideoBundle")?d="bundle":n.url.includes("DmcVideos")?d="videos":n.url.includes("DmcSeries")&&(d="series"),n.url.includes("ts-bypass=true")?(addHeaderEntry("authorization",t,n.requestHeaders),{requestHeaders:n.requestHeaders}):(d&&(e[d]=n.requestHeaders,s[d]=n.url),t=t||getHeaderValue("authorization",n.requestHeaders),{requestHeaders:n.requestHeaders})},{urls:["https://search-api-disney.svcs.dssott.com/svc/content/DmcVideo*","https://search-api-disney.svcs.dssott.com/svc/content/DmcSeries*"]},["requestHeaders","blocking"])})();