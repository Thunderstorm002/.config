(async()=>{const e="generic-fallback",t=e,n=browser.runtime.connect({name:e}),o=await getSettingsViaPort(n),s=o.settings,i=o.keys;if(!s[i.general.enableGenericFallback])return;if(await window.twoseven.isPaused())return;const a=[];async function r(e){async function o(){const{topURL:e}=await new Promise(e=>{n.onMessage.addListener(function t(o){const{action:s}=o;"frame-identity"===s&&(n.onMessage.removeListener(t),e(o))}),n.postMessage({action:"frame-identity"})}),t=new URI(e);if(t.addSearch({"ts-generic-fallback":1}),!s[i.general.genericFallbackWebsites].some(e=>t.host().includes(e)))return;const o=await window.twoseven.getModule(t.toString());let a;const r={action:"add-tab-media",from:"websites/generic-fallback.js",to:"bg/tag-media",data:{videoSelector:"webpage",videoURL:t.toString(),videoData:{module:{name:"generic-fallback"}},referer:window.location.href,origin:window.location.origin,strategies:null,headers:[],extensionProperties:{warnText:"Only use this option if no other video was detected or if the detected video does not work"}}};o.setupTabMediaListeners&&(a=await o.setupTabMediaListeners(r.data)),a&&Object.assign(r.data,{listenerEventsID:a}),n.postMessage(r)}a.push(e),["play","pause","seek","timeupdate"].forEach(t=>once(e,t,o)),twosevenExtLog(t,"Processed video element")}const c=["video"];function d(){const e=[];c.forEach(t=>{const n=[...document.querySelectorAll(t)];e.push(...n)});const n=e.filter(e=>!a.includes(e));if(n.length>0){twosevenExtLog(t,`Processing elements: ${n.length}`);for(const t of e)r(t)}}const l=new MutationObserver(e=>{for(const t of e){t.addedNodes.length>0&&d()}});d(),l.observe(document,{childList:!0,subtree:!0}),await window.twoseven.isOnTwoSevenTab()&&l.disconnect()})();