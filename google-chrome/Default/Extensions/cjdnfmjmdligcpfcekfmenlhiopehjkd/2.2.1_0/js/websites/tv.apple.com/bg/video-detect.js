(()=>{const e=["watch-iframe[tv.apple.com]"];browser.runtime.onConnect.addListener(t=>{e.includes(t.name)}),browser.webRequest.onBeforeSendHeaders.addListener(e=>{if(e.url.includes("ts-bypass=true"))return{requestHeaders:e.requestHeaders};const{tabId:t,frameId:r}=e,{[t]:n}=tabURLs;return(async()=>{const s=new URI(e.url),a=s.origin(),i=n;s.addQuery({"ts-bypass":!0});const o=await fetch(s.toString()),d=await o.text(),c=JSON.parse(d),{data:{content:{playables:l}}}=c;if(l.length>1)return void twosevenExtLog("[tv.apple.com:video-detect-bg]",`Found multiple playables: ${n}`,"warn");const[u]=l,{id:p,title:b,url:g,isGeoRestricted:v,contentId:w,canonicalId:m,images:{coverArt:f,coverArt16X9:y=f}}=u,{url:I}=y,S={videoSelector:"webpage",videoURL:g,videoData:{poster:I,title:b,referer:n,origin:a,id:p,contentId:w,canonicalId:m,isGeoRestricted:v},origin:a,referer:i,strategies:null,headers:[]};addTabMedia(t,r,S),0!==r&&twosevenTabs[t]&&browser.tabs.executeScript(t,{frameId:r,code:`triggerEvent(window, 'controller-event', JSON.stringify({\n            action: 'sourceChange',\n            mediaEntry: '${JSON.stringify(S)}'\n          }), true)`})})(),{requestHeaders:e.requestHeaders}},{urls:["https://tv.apple.com/api/uts/v2/view/product/umc*/personalized*"]},["requestHeaders","blocking"])})();