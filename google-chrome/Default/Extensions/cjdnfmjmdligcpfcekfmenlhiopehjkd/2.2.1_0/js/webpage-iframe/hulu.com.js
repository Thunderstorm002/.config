(()=>{if(window.top===window)return;const e="watch-iframe[hulu]",t=e;async function n(e,t={}){const{result:n}=await postTo(window,{action:"player-cmd",drmIgnore:!0,cmd:e,...t},!0);return n}const o=new WebpageIframeModule({name:e,hrefURLRegex:new RegExp("https://(.*\\.)?hulu.com/.*"),earlyInitialize(){(async()=>{await waitForDOMNode({type:"selector",value:".auth-login"}),window.twoseven.toast({msg:'Log out and log back into <a class="toast-close" href="https://www.hulu.com" target="_blank">Hulu in a new tab</a>. Then refresh this page.'})})();const o=browser.runtime.connect({name:e});if(this.port=o,window.twoseven.is.chrome()){const e="ts-hulu-reload";if(!sessionStorage.getItem(e))return sessionStorage.setItem(e,1),void(async()=>{await sendMessageToBG("clear-cache",{url:window.location.href,origins:[window.location.origin,"https://player.hulu.com"]}),twosevenExtLog(t,"Reloading once after clearing cache"),window.location.reload()})();o.postMessage({action:"redirect-url",urls:{[window.twoseven.HULU_PLAYER_BUILD_URL]:browser.extension.getURL("js/websites/hulu/dummy_load_player_build.js")}}),window.twoseven.testForEvent(window,"hulu:playerBuildModifierMap",8e3).catch(()=>{window.twoseven.reportError(t,new Error("Did not receive 'hulu:playerBuildModifierMap' event"))}),window.addEventListener("tsModifyBuildScript",async e=>{twosevenExtLog(t,`Received tsModifyBuildScript event. Modifying... ${e.detail.data}`);const{detail:{data:n}}=e,o=new URI(n);o.addQuery({"ts-fixup":"cors"});const i=await fetch(o.toString()),a=await i.text(),r=await modifyScript(a,window.twoseven.huluPlayerBuildModifierMap,t,o.toString());twosevenExtLog(t,"Sending back modified build script via tsModifyBuildScriptResponse"),triggerEvent(window,"tsModifyBuildScriptResponse",r,!0)}),twosevenExtLog(t,"Set up tsModifyBuildScript listener"),(async()=>{const e=await new Promise(e=>{o.onMessage.addListener(function t(n){"get-index-script-url"===n.action&&(o.onMessage.removeListener(t),e(n.data))}),o.postMessage({action:"get-index-script-url"})}),n=new URI(e).path(),i=await waitForDOMNode({type:"tag",value:"head"}),a=[...i.querySelectorAll("link[as=script]")].find(e=>e.href.match(window.twoseven.HULU_INDEX_REGEX)),r=[...i.querySelectorAll("link[as=script]")].find(e=>e.href.includes(n)),s=[...i.querySelectorAll("link")].find(e=>e.href.match(window.twoseven.HULU_PAGES_APP_REGEX)),c=[...i.querySelectorAll("link")].find(e=>e.href.match(window.twoseven.HULU_NEXT_PAGES_APP_REGEX));[{regex:window.twoseven.HULU_INDEX_REGEX,node:a,replaceMap:window.twoseven.huluIndexModifierMap},{regex:e,node:r,replaceMap:window.twoseven.huluIndexModifierMap},{regex:window.twoseven.HULU_PAGES_APP_REGEX,node:s,replaceMap:window.twoseven.huluPagesAppModifierMap},{regex:window.twoseven.HULU_NEXT_PAGES_APP_REGEX,node:c,replaceMap:window.twoseven.huluPagesAppModifierMap}].forEach(async e=>{const{regex:n,replaceMap:o}=e;let{node:a}=e;a||(a=await waitForDOMNode({type:"check",value:e=>"LINK"===e.tagName&&!!e.href.match(n)}));const{href:r}=a;i.removeChild(a);const s=`${r}?allow=true&ts-fixup=cors`,c=await fetch(s),d=await c.text(),l=await modifyScript(d,o,t,s),w=URL.createObjectURL(new Blob([l],{type:"text/javascript"}));injectScriptByURL(w)})})()}injectScript("\n        window.addEventListener('message', async ({ data = {} }) => {\n          if (data.action !== 'player-cmd') {\n            return\n          }\n          const { cmd, ack } = data\n          let result\n          try {\n            switch (cmd) {\n              case 'play':\n                await window.twoseven.huluController.play()\n                break\n              case 'pause':\n                await window.twoseven.huluController.pause()\n                break\n              case 'currentTime':\n                result = window.twoseven.huluController.getCurrentTime()\n                break\n              case 'seek':\n                const { position } = data\n                await window.twoseven.huluController.seek(position / 1e3)\n                break\n              case 'duration':\n                result = window.twoseven.huluController.duration\n                break\n              case 'status':\n                result = window.twoseven.huluController.paused ? 'paused' : 'playing'\n                break\n            }\n          } catch (e) {\n            // We don't care for this error too much..just need to make sure ack is sent back\n          }\n          if (ack) {\n            window.postMessage({\n              action: ack.event,\n              drmIgnore: true,\n              json: { result }\n            }, '*')\n          }\n        })\n      ");const i=new XRegExp("EAB::(?<uuid>[0-9a-fA-F]{8}\\-[0-9a-fA-F]{4}\\-[0-9a-fA-F]{4}\\-[0-9a-fA-F]{4}\\-[0-9a-fA-F]{12})::.*");o.onMessage.addListener(e=>{const{data:t}=e,{event:n,content_id:o="",period_type:a}=t;switch(n){case"redirect-url":injectScriptByURL(t.target);break;case"player_source_render_start":"content"!==a&&(this.shouldBlockFirstPlay=!0);break;case"player_start":{const e=XRegExp.exec(o,i);if(!e)return;const{uuid:t}=e;this.videoURL=`${window.location.origin}/watch/${t}`;break}}}),window.twoseven.is.chrome()&&window.addEventListener("twoseven-hulu-app-script-url",async e=>{const{detail:{data:{url:n}}}=e,o=new URI(n);o.addQuery({"ts-fixup":"cors"});const i=await fetch(o.toString()),a=await i.text(),r=await modifyScript(a,window.twoseven.huluAppModifierMap,t,o.toString()),s=URL.createObjectURL(new Blob([r],{type:"text/javascript"})),c=document.createElement("script");c.src=s,c.async=!0,c.onload=(()=>{triggerEvent(window,"twoseven-hulu-app-script-added")}),document.head.appendChild(c)}),attachHistoryListeners(),window.addEventListener("pushstate",e=>{const{detail:{data:n}}=e;twosevenExtLog(t,`Current URL: ${JSON.stringify(n)}`)}),window.addEventListener("controller-event",async function(e){const{detail:{data:o}}=e,{action:i}=o,a={action:i,name:window.name,json:{position:1e3*await n("currentTime")}};switch(i){case"play":this.shouldBlockFirstPlay;break;case"seek":Object.assign(a.json,{position:1e3*o.position});break;case"controller-changed":await this.onVideo(o)}this.initialized?(twosevenExtLog(t,`Controller wanted to action=${i}`),postToParent(a)):twosevenExtLog(t,`Controller wanted to action=${i} ...ignored since controller hasn't initialized yet`)}.bind(this))},fullscreenCallback:()=>!0,getActions:()=>({play:()=>n("play"),pause:()=>n("pause"),async seek({position:e}){const t=await n("currentTime");if(!(Math.abs(e-1e3*t)<100))return n("seek",{position:e})},sourceChange(e){},currentTime:()=>n("currentTime"),duration:()=>n("duration"),source(){return this.videoURL},playerStatus:()=>n("status"),interactiveChoice(e){}}),async onVideo(e){const{position:t,hasIntro:o}=e;await n("pause"),void 0!==t&&await n("seek",{position:t}),await this.emit("controller-ready",{videoURL:this.videoURL}),setTimeout(()=>this.emit("controller-initialized"),1e3)},async getVideoURL(){return this.videoURL},isValidVideoElement:()=>!1,videoSelector:()=>"hulu"});registerWebpageIframeModule(o)})();