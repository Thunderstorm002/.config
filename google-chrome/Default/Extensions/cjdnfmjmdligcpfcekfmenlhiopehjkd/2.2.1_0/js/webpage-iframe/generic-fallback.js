(()=>{const e="watch-iframe[generic]";class t extends BaseModule{constructor(...t){super(...t),this.name=this.name||e,this.fullscreenCallback=(()=>!0),this.useActionsAsControls=!0}check(e){return e.includes("ts-generic-fallback=1")&&super.check(e)}async earlyInitialize(){const{name:t}=this;this.port=browser.runtime.connect({name:t}),this.textTracks=[],this.pendingTextTracks=[],window.addEventListener("message",async t=>{const{data:i={}}=t,{action:n}=i;if("found-caption"!==n)return;let{data:{language:o="--",label:s="--",srclang:a="--",kind:r="captions",vtt:d,url:w}}=i;if(!d)try{const i=await fetch(w);d=await i.text()}catch(t){twosevenExtLog(e,`Failed to get caption: ${w}`)}const c=md5(d);if(this.textTracks.find(e=>e.dataset.hash===c))return;const l=new Blob([d],{type:"text/vtt"}),h=URL.createObjectURL(l),u=document.createElement("track");u.kind=r,u.label=s,u.src=h,u.language=o,u.srclang=a,u.default=!0,u.dataset.hash=c,this.video?this.video.video.appendChild(u):this.textTracks.push(u)}),this.isOnTwoSeven=await window.twoseven.isOnTwoSeven()}getActions(){return window.twoseven.initializePlyrActions(()=>this.getVideo())}getFrame(){return this.iframe}getVideo(){return this.video.video}async onVideo(e){this.video=e}setupWrap(){window.addEventListener("mod-wrap",()=>{this.wrap()}),window.addEventListener("mod-unwrap",()=>{this.unwrap()})}isValidVideoElement(e){return!0}unwrap(){const{video:{video:e}}=this;window.twoseven.revertPlyr(e)}async wrap(e){const{video:{video:t}}=this,i=await window.twoseven.getMediaEntry(this.port);return i.videoData.textTracks=this.textTracks,window.twoseven.wrapWithPlyr(t,i,e)}}window.BaseGenericFallbackModule=t;const i=new class extends t{async check(e){const{twoseven:{genericFallbackBlacklistedUrls:t}}=window;if(window.parent!==window.top){const{href:t}=await postToParent({action:"get-parent-url"},!0);e=t}return e.includes("ts-generic-fallback=1")&&!t.some(t=>e.match(t))}async earlyInitialize(){super.earlyInitialize();const{port:e}=this;window.parent!==window.top?window.addEventListener("message",async e=>{try{const{data:t}=e,{action:i}=t;if("same-url"!==i)return;this.iframe?await postTo(this.iframe.contentWindow,t,!0):(await this.wrap(window.top),await this.video.video.pause()),postResponse(e,{})}catch(e){}}):(this.port=e,window.location.href.includes("ts-inner-iframe=1")&&(this.videoInSubFrame=!0),window.addEventListener("message",function(e){const{data:t={}}=e,{action:i}=t;if("found-video"===i){if(e.source!==window){const t=Array.from(document.querySelectorAll("iframe")).find(t=>t.contentWindow===e.source);t.classList.add("twoseven-fullscreen"),this.iframe=t,document.body.style["overflow-y"]="hidden",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style["z-index"]="2147483638"}this.on("same-url",async e=>{this.iframe?await postTo(this.iframe.contentWindow,{action:"same-url"},!0):(await this.wrap(),await this.video.video.pause()),this.emit("controller-initialized")}),this.emit("controller-ready")}}.bind(this))),this.isOnTwoSeven=await window.twoseven.isOnTwoSeven()}getActions(){return this.videoInSubFrame&&window.parent===window.top?window.twoseven.initializeIntermediateIframeActions(()=>this.getFrame().contentWindow):window.twoseven.initializePlyrActions(()=>this.getVideo())}getVideo(){if(!this.videoInSubFrame||window.parent!==window.top)return this.video.video;console.warn("Requesting getVideo() on an intermediate frame")}async onVideo(e){super.onVideo(e);const{video:t}=e;once(t,"play",async()=>{const e=window.parent===window.top?window:window.parent;await this.setupWrap(),postTo(e,{action:"found-video"})}),window.parent!==window.top&&(this.videoInSubFrame=!0)}};registerGenericFallbackModule(i,!0)})();