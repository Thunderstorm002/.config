(()=>{const e="watch-iframe[amazon]",t=e;async function n(e,t={}){const{result:n}=await postTo(window,{action:"player-cmd",drmIgnore:!0,cmd:e,...t},!0);return n}const s=new WebpageIframeModule({name:e,hrefURLRegex:new RegExp("https://(.*\\.)?(amazon|primevideo).co(m|\\.[a-z]+)/.*"),earlyInitialize(){const s=browser.runtime.connect({name:e});if(this.port=s,window.twoseven.is.chrome()){{const e="ts-amazon-reload";if(!sessionStorage.getItem(e))return sessionStorage.setItem(e,1),void(async()=>{await sendMessageToBG("clear-cache",{url:window.location.href,origins:[window.location.origin,"https://js-assets.aiv-cdn.net","https://cloudfront.xp-assets.aiv-cdn.net"]}),twosevenExtLog(t,"Reloading once after clearing cache"),window.location.reload()})()}s.postMessage({action:"redirect-url",urls:{[ATVWebPlayerURLRegexPattern]:browser.extension.getURL("/web_resources/js/amazon/ATVWebPlayer.js")}})}let a,i,r,o,c,l;(async()=>{injectScriptByURL(browser.extension.getURL("js/redist/on-change.umd.js"))})(),window.addEventListener("page-elements",e=>{const{target:n,detail:{data:s}}=e,{name:a}=s;this[a]!==n&&(console.log(`[${t}]: Detected element: ${a}`,n),this[a]=n)}),s.onMessage.addListener(function(e){switch(e.action){case"sourceChange":{let t=!1;try{t=this.checkASIN(this.videoURL,e.json.videoURL)}catch(e){}t||(this.videoURL=e.json.videoURL,this.emit("controller-ready",e.json))}break;case"bg-event":this.video||(this.searchInterval=this.searchInterval||setInterval(()=>{const e=Array.from(document.querySelectorAll("video"));this.emit("process-video-elements",e)},100))}}.bind(this)),injectScript("\n        // Currently, we only do seek via the controller\n        window.addEventListener('message', async ({ data = {} }) => {\n          if (data.action !== 'player-cmd') {\n            return\n          }\n          const { cmd, ack } = data\n          let result\n          const controller = window.twoseven.amazonController\n          const { webPlayer } = controller\n          const { mediaPlayerCore } = webPlayer\n          let { player } = webPlayer\n          let seekOffset = 0\n          if (!player) {\n            player = mediaPlayerCore\n          }\n\n          switch (cmd) {\n            case 'play':\n              await player.play()\n              break\n            case 'pause':\n              await player.pause()\n              break\n            case 'currentTime':\n              result = webPlayer.getPosition()\n              break\n            case 'duration':\n              result = webPlayer.getDuration()\n              break\n            case 'seek':\n              const { position } = data\n              await webPlayer.seek((position) / 1e3)\n              break\n          }\n          if (ack) {\n            window.postMessage({\n              action: ack.event,\n              drmIgnore: true,\n              json: { result }\n            }, '*')\n          }\n        })\n      ");const d=e=>(32===e.which||13===e.which)&&(e.preventDefault(),e.stopImmediatePropagation(),!0),u=e=>this.playPauseBtn||e.target.closest(".pausedOverlay").children[0].children[1],p=async e=>{const{plyr:t,video:s}=this;s.addEventListener("seeked",async function e(){s.removeEventListener("seeked",e);const a=await n("currentTime");t.seek(1e3*a)})},y=async e=>{const{target:t}=e,{parentNode:s}=t,i=u(e);if(t===a||t===o||s===i){this.getVideo().video.paused?this.plyr.pause():this.plyr.play()}else if(t===i){this.getVideo().video.paused?this.plyr.play():this.plyr.pause()}const r=await n("currentTime");this.plyr.seek(1e3*r)},v=async e=>{d(e)&&y(e)},m=e=>(e.stopImmediatePropagation(),e.preventDefault(),postToParent({action:"fullscreen",name:name}),!1),h=async e=>{d(e)&&m(e)};async function w(e){const{video:t,plyr:s}=this;if(!(e.ctrlKey||e.shiftKey||e.altKey))switch(e.which){case 32:t.paused?s.play():s.pause();break;case 37:case 39:{const e=await n("currentTime");s.seek(1e3*e);break}}}const k=async e=>{await new Promise(e=>setTimeout(e,300));const t=await n("currentTime");this.plyr.seek(1e3*t)},g=async e=>{d(e)&&k()},L=async e=>{y(e)},f=async e=>{d(e)&&(e.target.click(),setTimeout(()=>L(e),0))};this.on("same-url",async e=>{this.controllerInitialized=!0;const t=document.querySelector(".fullscreenButtonWrapper"),s=document.querySelector(".skipElement");this.pausedOverlay?(a=this.pausedOverlay,i=this.pausedOverlay.parentNode,r=this.seekBar,o=this.playPauseBtn.parentNode,c=this.fastSeekBack,l=this.fastSeekForward):(a=document.querySelector(".pausedOverlay"),i=document.querySelector(".overlaysContainer"),r=document.querySelector(".seekBar"),o=a.querySelector(".buttons"),c=o.querySelector(".fastSeekBack"),l=o.querySelector(".fastSeekForward"),Object.assign(this,{currentNodes:{pausedOverlay:a,overlaysContainer:i,progressBar:r,overlayBtns:o,fastSeekBack:c,fastSeekForward:l}})),r.removeEventListener("click",p),r.addEventListener("click",p),a.removeEventListener("click",y),a.removeEventListener("keyup",v),a.addEventListener("click",y),a.addEventListener("keyup",v),t.removeEventListener("click",m),t.removeEventListener("keyup",h),t.addEventListener("click",m),t.addEventListener("keyup",h),s&&(s.removeEventListener("click",k),s.removeEventListener("keyup",g),s.addEventListener("click",k),s.addEventListener("keyup",g));const d=u({target:a});d.removeEventListener("keyup",v),d.addEventListener("keyup",v),l.removeEventListener("click",L),l.removeEventListener("keyup",f),l.addEventListener("click",L),l.addEventListener("keyup",f),c.removeEventListener("click",L),c.removeEventListener("keyup",f),c.addEventListener("click",L),c.addEventListener("keyup",f),i.removeEventListener("keyup",w),i.addEventListener("keyup",w),await n("pause");const{status:E}=e;"paused"===E&&setTimeout(()=>{}),await this.emit("controller-initialized")})},initialize(){},fullscreenCallback:()=>!0,useBodyObserver:()=>!1,getActions(){const e=window.twoseven.initializeGenericIframeActions(),t=this;return Object.assign(e,{async seek({position:e}){const t=await n("currentTime");Math.abs(e-1e3*t)<100||await n("seek",{position:e})},currentTime(){const{video:e}=t;return e.currentTime-10}}),e},getVideo(){return this.plyr},isValidVideoElement(e){if((!this.video||e!==this.video)&&100===e.width)return this.video!==e&&once(e,"play",()=>{this.emit("controller-ready")}),this.video=e,twosevenExtLog(t,"Found valid video element"),!0},async onVideo(e,t){this.plyr=e,Object.assign(e,{async play(e){if(e)return n("play");{const e=await n("currentTime");postToParent({action:"play",name:name,json:{position:1e3*e}})}},async pause(e){if(e)return n("pause");{const e=await n("currentTime");postToParent({action:"pause",name:name,json:{position:1e3*e}})}},async seek(e,t){t?n("seek",{position:e}):postToParent({action:"seek",name:name,json:{position:e}})}}),Object.defineProperty(e,"currentTime",{get:function(){return e.video.currentTime}}),this.video=t,window.location.href.endsWith("?autoplay=1")&&(this.videoURL=window.location.href,twosevenExtLog("Got video. Emitting controller-ready"),this.emit("controller-ready",{videoURL:this.videoURL}))},doVideoURLsMatch(e,n){const{videoURL:s,videoData:a}=e,{videoURL:i,videoData:r}=n;try{const{asin:e,compactGTI:n,fullGTI:o,allIDs:c}=a,{asin:l,compactGTI:d,fullGTI:u,allIDs:p}=r;let y,v;c&&p?(y=c,v=p):(y=[e,o,n].filter(e=>!!e),v=[l,u,d].filter(e=>!!e));const m=v.find(e=>y.includes(e));if(m)return twosevenExtLog(t,`Skipping sourceChange since ASIN matched: ${m}`),!0}catch(e){try{return this.checkASIN(s,i)}catch(e){twosevenExtLog(t,`Failed checkASIN: ${e.message}\n${e.stack}`,"warning")}}return twosevenExtLog(t,"Checking raw URLs","warning"),console.warn((new Error).stack),s===i},checkASIN(e,t){const n=new RegExp(".*detail/(.*)?/.*");return e.match(n)[1]===t.match(n)[1]},videoSelector:()=>"amazon",async getMediaElement(){return this.video}});registerWebpageIframeModule(s)})();