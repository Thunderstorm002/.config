(()=>{const e="[amazon-video]->video-url-finder";var t={};const a="https://atv-ps(-[a-z]+)?\\.(amazon|primevideo)\\.([a-z.])+/cdp",r=new RegExp(`${a}/catalog/GetPlaybackResources.*`),s=new RegExp(`${a}/usage/UpdateStream.*`);function o(a,r,s){try{const o=Array.from(t[a][r]);twosevenExtLog(e,`Informing ${a}:${r} of message`);for(const e of o)try{e.postMessage(s)}catch(e){console.error(`Failed to send message to port: ${a}:${r}: ${e.message}`,e)}}catch(e){console.error("Failed to inform amazon via ports")}}var n;function i(e,t){const a=e.origin().includes("primevideo.");let r=`${e.origin()}/gp/video/detail/${t}/?autoplay=1`;return a&&(r=`${e.origin()}/detail/${t}/?autoplay=1`),r}let c;browser.runtime.onConnect.addListener(a=>{if("amazon-iframe"!==a.name&&"amazon-media-finder"!==a.name&&"watch-iframe[amazon]"!==a.name&&"generic-fallback[amazon]"!==a.name)return;const r=getTabIdFromPort(a),s=a.sender.frameId;t[r]||(t[r]={});const o=t[r];o[s]||(o[s]=new Set);const n=o[s];n.add(a),twosevenExtLog(e,`Registered amazon port from ${r}:${s}`),a.onMessage.addListener(e=>{}),a.onDisconnect.addListener(()=>n.delete(a))});const d=new RegExp(`${a}/.*`);browser.webRequest.onBeforeSendHeaders.addListener(t=>{if(!d.test(t.url))return{requestHeaders:t.requestHeaders};if(r.test(t.url))return n=t.requestHeaders,{requestHeaders:t.requestHeaders};if(!s.test(t.url))return{requestHeaders:t.requestHeaders};const{tabId:a,frameId:l}=t,u=new URI(t.url),p=u.query(!0),{event:m,titleId:g,asin:f=g}=p;if(o(a,l,{action:"bg-event",data:{event:m,asin:f}}),!new Set(["START","PLAY","PAUSE"]).has(m))return{requestHeaders:t.requestHeaders};const{documentUrl:w,initiator:y=w}=t,{[a]:v}=tabURLs,b=new URI(v);let h=b;"twoseven.xyz"===b.domain()&&(h=new URI(y));const I=i(h,f),S=i(h,void 0);return c!==f&&void 0!==f||!(twosevenTabs[a]||tabMediaHasEntry(a,{videoURL:I})||tabMediaHasEntry(a,{videoURL:S}))?(c=f,async function(e,t){const a=new URI(`${t}/cdp/catalog/GetPlaybackResources?consumptionType=Streaming&liveManifestType=live%2Caccumulating&desiredResources=PlaybackUrls%2CCatalogMetadata%2CForcedNarratives%2CSubtitlePresets%2CSubtitleUrls%2CTransitionTimecodes%2CTrickplayUrls%2CCuepointPlaylist%2CXRayMetadata%2CPlaybackSettings&deviceTypeID=AOAGZA014O5RE&firmware=1&marketplaceID=ATVPDKIKX0DER&resourceUsage=CacheResources&videoMaterialType=Feature&operatingSystemName=Windows&operatingSystemVersion=10.0&deviceDrmOverride=CENC&deviceStreamingTechnologyOverride=DASH&deviceProtocolOverride=Https&supportedDRMKeyScheme=DUAL_KEY&deviceBitrateAdaptationsOverride=CVBR%2CCBR&titleDecorationScheme=primary-content&subtitleFormat=TTMLv2&languageFeature=MLFv2&uxLocale=en_US&xrayDeviceClass=normal&xrayPlaybackMode=playback&xrayToken=INCEPTION_LITE_FILMO_V2&playbackSettingsFormatVersion=1.0.0`);a.removeSearch("marketplaceID"),a.addSearch({asin:e,gascEnabled:!t.includes("amazon."),clientId:uuid.v4(),userWatchSessionId:uuid.v4(),deviceId:await SimpleCrypto.sha224(`${Math.random()}`),"ts-bypass":!0});const r=a.toString();let s,o,i,c,d,l;try{const e={};for(const{name:t,value:a}of n)e[t]=a;const t=await axios.get(r,{headers:e}),{data:a}=t,{catalogMetadata:u}=a;try{const{family:{tvAncestors:e}}=u;for(const t of e){const{catalog:e}=t,{type:a}=e;switch(a.toUpperCase()){case"SEASON":{const{seasonNumber:t}=e;c=t;break}case"SHOW":{const{title:t}=e;d=t;break}}}}catch(e){}try{const{catalog:e}=u,{episodeNumber:t,title:a}=e;i=t;try{l=a,l=JSON.parse(a)}catch(e){}}catch(e){}s=u.images.imageUrls.title,o=u.catalog.title;try{o+=` - ${u.family.tvAncestors[0].catalog.title}`}catch(e){}}catch(e){}return{asin:e,title:o,poster:s,episodeIndex:i,episodeTitle:l,seasonIndex:c,showTitle:d}}(f,u.origin()).then(async r=>{r.title;let s=I;const n=await axios.get(s),{request:{responseURL:i}}=n,c=new URI(i);s=`${c.origin()}/${c.path()}?autoplay=1`;const d=[...(new DOMParser).parseFromString(n.data,"text/html").querySelectorAll("script")].filter(e=>e.text.startsWith("{")).map(e=>JSON.parse(e.text));let u={};d.forEach(e=>{const t=Flat.flatten(e);u=deepmerge(u,t)});const p="props.state.self";let m=f,g=u[`${p}.${f}.compactGTI`],w=u[`${p}.${f}.gti`],y=new Set;if(!g)try{const t=Object.entries(u).filter(e=>e[1]===f&&e[0].startsWith(p));if(1!==t.length)throw new Error("Multiple possibilities. Cannot proceed");const a=t[0],r=new RegExp(`${p}.([a-zA-Z0-9]+).(asins.\\d+|gti)`),s=a[0].match(r);if(!s)throw new Error(`Regex (${r.toString()}) did not match string '${t[0]}'`);m=s[1];const o=u[`${p}.${m}.compactGTI`],n=u[`${p}.${m}.gti`];if(!o||!n)throw new Error(`Failed to find GTI for ${f}->${m}`);g=o,w=n}catch(t){twosevenExtLog(e,`Failed to find 'real' asin for ${f}: ${t.message}`,"warning"),g=f,w=f}if(g!==f)try{y.add(m),Object.entries(u).filter(e=>e[0].startsWith(`${p}.${m}.asins`)).map(e=>e[1]).forEach(y.add,y),y.add(g),y.add(w),y=[...y]}catch(e){}if(s=s.replace(new RegExp(f),g),Object.assign(r,{asin:f,compactGTI:g,fullGTI:w,allIDs:y}),o(a,l,{from:e,action:"sourceChange",json:{videoURL:h.origin().includes("amazon.")?`${h.origin()}/gp/video/detail/${g}/?autoplay=1`:`https://www.primevideo.com/detail/${g}/?autoplay=1`,videoData:r}}),0===t.frameId){const e=await getTabByTabId(a),{url:t}=e;new URI(t).addSearch({autoplay:1,webpage:1})}}),{requestHeaders:t.requestHeaders}):{requestHeaders:t.requestHeaders}},{urls:["<all_urls>"]},["blocking","requestHeaders"]),browser.webRequest.onBeforeSendHeaders.addListener(async t=>{const{tabId:a,frameId:s,url:o,requestHeaders:n}=t;if(!t.url.includes("ts-bypass=true")&&r.test(o)){const r=new URI(o);r.addSearch({"ts-bypass":!0});const i={};for(const{name:e,value:t}of n)i[e]=t;try{const o=await axios.get(r.toString()),{data:{subtitleUrls:n}}=o;for(const t of n){const{languageCode:r,url:o,format:n}=t;"dfxp"!==n.toLowerCase()&&twosevenExtLog(e,"WARNING: Bad format","warning");const i=await fetch(o),c=await i.text(),d=xmlToSrt(c,r),l=subsrt.parse(d),u={action:"found-caption",data:{language:r,vtt:subsrt.build(l,{format:"vtt"})}};0!==s&&twosevenTabs[a]&&browser.tabs.executeScript(a,{frameId:s,code:`;(() => { const postTo = tsExtGetPostTo(); postTo(window, ${JSON.stringify(u)}) })()`})}}catch(t){}}},{urls:["https://*/*"]},["requestHeaders"]),browser.webRequest.onHeadersReceived.addListener(e=>{const{tabId:t,frameId:a}=e;return twosevenTabs[t]&&0!==a?(addCORS(e.responseHeaders),{responseHeaders:e.responseHeaders}):{responseHeaders:e.responseHeaders}},{urls:["https://*.cloudfront.net/*.ttml2"]},["responseHeaders","blocking"])})();